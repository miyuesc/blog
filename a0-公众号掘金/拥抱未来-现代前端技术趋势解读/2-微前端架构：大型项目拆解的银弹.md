# å¾®å‰ç«¯æ¶æ„ï¼šå¤§å‹é¡¹ç›®æ‹†è§£çš„"é“¶å¼¹"

> è¿˜åœ¨ä¸ºå·¨çŸ³åº”ç”¨çš„ç»´æŠ¤è€Œå¤´ç–¼ï¼Ÿå›¢é˜Ÿåä½œæ€»æ˜¯äº’ç›¸è¸©å‘ï¼Ÿä¸åŒæŠ€æœ¯æ ˆæ— æ³•å…±å­˜ï¼Ÿåˆ«æ€¥ï¼Œå¾®å‰ç«¯æ¥æ‹¯æ•‘ä½ äº†ï¼ä»Šå¤©æˆ‘ä»¬å°±æ¥æ·±å…¥æ¢ç´¢è¿™ä¸ªè¢«èª‰ä¸ºå¤§å‹å‰ç«¯é¡¹ç›®"é“¶å¼¹"çš„æ¶æ„æ¨¡å¼ã€‚

## å‰è¨€ï¼šå½“å‰ç«¯é¡¹ç›®å˜æˆ"å·¨çŸ³æ€ª"

æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼šä½ çš„å…¬å¸æœ‰ä¸€ä¸ªå·²ç»å¼€å‘äº†3å¹´çš„å‰ç«¯é¡¹ç›®ï¼Œä»£ç é‡è¶…è¿‡50ä¸‡è¡Œï¼Œæ¶‰åŠç”¨æˆ·ç®¡ç†ã€è®¢å•ç³»ç»Ÿã€æ•°æ®åˆ†æã€å®¢æœç³»ç»Ÿç­‰åå‡ ä¸ªä¸šåŠ¡æ¨¡å—ã€‚ç°åœ¨çš„é—®é¢˜æ˜¯ï¼š

- ğŸŒ **æ„å»ºç¼“æ…¢**ï¼šæ¯æ¬¡æ„å»ºéœ€è¦10åˆ†é’Ÿä»¥ä¸Š
- ğŸ”¥ **éƒ¨ç½²é£é™©**ï¼šä¸€ä¸ªå°æ”¹åŠ¨å¯èƒ½å½±å“æ•´ä¸ªç³»ç»Ÿ
- ğŸ‘¥ **å›¢é˜Ÿå†²çª**ï¼šå¤šä¸ªå›¢é˜Ÿåœ¨åŒä¸€ä¸ªä»£ç åº“é‡Œå¼€å‘ï¼Œç»å¸¸äº§ç”Ÿå†²çª
- ğŸ”§ **æŠ€æœ¯å€ºåŠ¡**ï¼šæƒ³å‡çº§Reactç‰ˆæœ¬ï¼Ÿç‰µä¸€å‘è€ŒåŠ¨å…¨èº«
- ğŸ“ˆ **æ‰©å±•å›°éš¾**ï¼šæ–°å¢ä¸€ä¸ªæ¨¡å—éœ€è¦äº†è§£æ•´ä¸ªç³»ç»Ÿæ¶æ„

è¿™å°±æ˜¯å…¸å‹çš„"å·¨çŸ³åº”ç”¨"é—®é¢˜ã€‚è€Œå¾®å‰ç«¯ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›ç—›ç‚¹è€Œç”Ÿçš„ã€‚

## ä¸€ã€å¾®å‰ç«¯çš„æ ¸å¿ƒç†å¿µï¼šåˆ†è€Œæ²»ä¹‹

### 1.1 ä»€ä¹ˆæ˜¯å¾®å‰ç«¯ï¼Ÿ

å¾®å‰ç«¯æ˜¯ä¸€ç§æ¶æ„æ¨¡å¼ï¼Œå®ƒå°†å¤§å‹å‰ç«¯åº”ç”¨æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹çš„ã€å¯éƒ¨ç½²çš„å°å‹å‰ç«¯åº”ç”¨ã€‚æ¯ä¸ªå°åº”ç”¨éƒ½å¯ä»¥ï¼š

- **ç‹¬ç«‹å¼€å‘**ï¼šä¸åŒå›¢é˜Ÿå¯ä»¥ä½¿ç”¨ä¸åŒçš„æŠ€æœ¯æ ˆ
- **ç‹¬ç«‹éƒ¨ç½²**ï¼šå¯ä»¥å•ç‹¬å‘å¸ƒï¼Œä¸å½±å“å…¶ä»–åº”ç”¨
- **ç‹¬ç«‹è¿è¡Œ**ï¼šåœ¨è¿è¡Œæ—¶ç»„åˆæˆä¸€ä¸ªå®Œæ•´çš„åº”ç”¨

```mermaid
graph TD
    A[å·¨çŸ³åº”ç”¨] --> B[ç”¨æˆ·æ¨¡å—]
    A --> C[è®¢å•æ¨¡å—]
    A --> D[æ•°æ®æ¨¡å—]
    A --> E[å®¢æœæ¨¡å—]
    
    F[å¾®å‰ç«¯æ¶æ„] --> G[ç”¨æˆ·å­åº”ç”¨<br/>React + TypeScript]
    F --> H[è®¢å•å­åº”ç”¨<br/>Vue 3 + Vite]
    F --> I[æ•°æ®å­åº”ç”¨<br/>Angular + RxJS]
    F --> J[å®¢æœå­åº”ç”¨<br/>Svelte + SvelteKit]
    
    K[ä¸»åº”ç”¨<br/>Shell App] --> G
    K --> H
    K --> I
    K --> J
```

### 1.2 å¾®å‰ç«¯çš„æ ¸å¿ƒä»·å€¼

```javascript
// ä¼ ç»Ÿå·¨çŸ³åº”ç”¨çš„é—®é¢˜
class MonolithApp {
  constructor() {
    this.modules = {
      user: new UserModule(),
      order: new OrderModule(),
      analytics: new AnalyticsModule(),
      support: new SupportModule()
    }
    
    // æ‰€æœ‰æ¨¡å—è€¦åˆåœ¨ä¸€èµ·
    this.dependencies = {
      shared: ['react@16.8.0', 'antd@4.0.0', 'moment@2.24.0'],
      conflicts: ['ç‰ˆæœ¬å†²çª', 'æ ·å¼å†²çª', 'å…¨å±€çŠ¶æ€å†²çª']
    }
  }
  
  deploy() {
    // å¿…é¡»æ•´ä½“éƒ¨ç½²
    return this.buildAll().then(this.deployAll)
  }
  
  update(module) {
    // æ›´æ–°ä¸€ä¸ªæ¨¡å—éœ€è¦é‡æ–°æ„å»ºæ•´ä¸ªåº”ç”¨
    return this.buildAll()
  }
}

// å¾®å‰ç«¯æ¶æ„çš„ä¼˜åŠ¿
class MicroFrontendApp {
  constructor() {
    this.subApps = {
      user: new UserSubApp({ framework: 'React', version: '18.0.0' }),
      order: new OrderSubApp({ framework: 'Vue', version: '3.0.0' }),
      analytics: new AnalyticsSubApp({ framework: 'Angular', version: '15.0.0' }),
      support: new SupportSubApp({ framework: 'Svelte', version: '3.0.0' })
    }
  }
  
  deploy(subAppName) {
    // å¯ä»¥ç‹¬ç«‹éƒ¨ç½²å•ä¸ªå­åº”ç”¨
    return this.subApps[subAppName].deploy()
  }
  
  update(subAppName) {
    // åªéœ€è¦æ„å»ºå’Œæ›´æ–°ç‰¹å®šçš„å­åº”ç”¨
    return this.subApps[subAppName].build().then(deploy)
  }
}
```

## äºŒã€å¾®å‰ç«¯å®ç°æ–¹æ¡ˆå¯¹æ¯”

### 2.1 ä¸»æµå®ç°æ–¹æ¡ˆæ¦‚è§ˆ

| æ–¹æ¡ˆ | æŠ€æœ¯åŸç† | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|----------|------|------|----------|
| **iframe** | æµè§ˆå™¨åŸç”Ÿéš”ç¦» | å®Œå…¨éš”ç¦»ã€ç®€å•æ˜“ç”¨ | æ€§èƒ½å·®ã€ä½“éªŒå‰²è£‚ | ç®€å•é›†æˆåœºæ™¯ |
| **single-spa** | è·¯ç”±åŠ«æŒ | ç”Ÿæ€æˆç†Ÿã€çµæ´»æ€§é«˜ | å­¦ä¹ æˆæœ¬é«˜ã€é…ç½®å¤æ‚ | å¤§å‹ä¼ä¸šåº”ç”¨ |
| **qiankun** | single-spa + æ²™ç®± | å¼€ç®±å³ç”¨ã€éš”ç¦»æ€§å¥½ | é˜¿é‡Œç³»æŠ€æœ¯æ ˆç»‘å®š | ä¸­å¤§å‹é¡¹ç›® |
| **MicroApp** | WebComponent | ç±»ä¼¼iframeä½“éªŒã€éš”ç¦»æ€§å¥½ | ç›¸å¯¹è¾ƒæ–°ã€ç”Ÿæ€å¾…å®Œå–„ | ç°ä»£åŒ–é¡¹ç›® |
| **Module Federation** | Webpack 5åŸç”Ÿ | æ€§èƒ½æœ€ä¼˜ã€å…±äº«ä¾èµ– | éœ€è¦Webpack 5 | ç°ä»£æ„å»ºå·¥å…·é¡¹ç›® |

### 2.2 qiankunæ·±åº¦è§£æ

ä½œä¸ºå›½å†…æœ€å—æ¬¢è¿çš„å¾®å‰ç«¯æ¡†æ¶ï¼ŒqiankunåŸºäºsingle-spaè¿›è¡Œäº†å°è£…ï¼Œæä¾›äº†æ›´å¥½çš„å¼€ç®±å³ç”¨ä½“éªŒã€‚

#### æ ¸å¿ƒæ¶æ„

```mermaid
graph TB
    A[ä¸»åº”ç”¨ Main App] --> B[åº”ç”¨æ³¨å†Œä¸­å¿ƒ]
    B --> C[è·¯ç”±ç³»ç»Ÿ]
    C --> D[ç”Ÿå‘½å‘¨æœŸç®¡ç†]
    D --> E[æ²™ç®±éš”ç¦»]
    E --> F[æ ·å¼éš”ç¦»]
    
    G[å­åº”ç”¨1<br/>React] --> H[å¯¼å‡ºç”Ÿå‘½å‘¨æœŸ]
    I[å­åº”ç”¨2<br/>Vue] --> J[å¯¼å‡ºç”Ÿå‘½å‘¨æœŸ]
    K[å­åº”ç”¨3<br/>Angular] --> L[å¯¼å‡ºç”Ÿå‘½å‘¨æœŸ]
    
    H --> D
    J --> D
    L --> D
```

#### ä¸»åº”ç”¨é…ç½®

```javascript
// main-app/src/main.js
import { registerMicroApps, start } from 'qiankun'

// æ³¨å†Œå­åº”ç”¨
registerMicroApps([
  {
    name: 'user-app', // åº”ç”¨åç§°
    entry: '//localhost:8081', // åº”ç”¨å…¥å£
    container: '#user-container', // åº”ç”¨æŒ‚è½½èŠ‚ç‚¹
    activeRule: '/user', // æ¿€æ´»è·¯ç”±
    props: {
      // ä¼ é€’ç»™å­åº”ç”¨çš„æ•°æ®
      userInfo: { id: 1, name: 'admin' },
      token: localStorage.getItem('token')
    }
  },
  {
    name: 'order-app',
    entry: '//localhost:8082',
    container: '#order-container',
    activeRule: '/order',
    props: {
      apiBase: 'https://api.example.com'
    }
  },
  {
    name: 'analytics-app',
    entry: '//localhost:8083',
    container: '#analytics-container',
    activeRule: '/analytics'
  }
])

// å¯åŠ¨qiankun
start({
  prefetch: true, // é¢„åŠ è½½
  sandbox: {
    strictStyleIsolation: true, // ä¸¥æ ¼æ ·å¼éš”ç¦»
    experimentalStyleIsolation: true // å®éªŒæ€§æ ·å¼éš”ç¦»
  },
  singular: false // æ˜¯å¦å•ä¾‹æ¨¡å¼
})
```

#### ä¸»åº”ç”¨å¸ƒå±€ç»„ä»¶

```vue
<!-- main-app/src/components/Layout.vue -->
<template>
  <div class="main-layout">
    <!-- å…¨å±€å¯¼èˆª -->
    <nav class="main-nav">
      <div class="nav-brand">
        <img src="/logo.png" alt="Logo" />
        <span>ä¼ä¸šç®¡ç†ç³»ç»Ÿ</span>
      </div>
      
      <ul class="nav-menu">
        <li>
          <router-link to="/user" :class="{ active: isActive('/user') }">
            <i class="icon-user"></i>
            ç”¨æˆ·ç®¡ç†
          </router-link>
        </li>
        <li>
          <router-link to="/order" :class="{ active: isActive('/order') }">
            <i class="icon-order"></i>
            è®¢å•ç®¡ç†
          </router-link>
        </li>
        <li>
          <router-link to="/analytics" :class="{ active: isActive('/analytics') }">
            <i class="icon-chart"></i>
            æ•°æ®åˆ†æ
          </router-link>
        </li>
      </ul>
      
      <div class="nav-user">
        <span>{{ userInfo.name }}</span>
        <button @click="logout">é€€å‡º</button>
      </div>
    </nav>
    
    <!-- å­åº”ç”¨å®¹å™¨ -->
    <main class="main-content">
      <!-- ç”¨æˆ·ç®¡ç†å­åº”ç”¨ -->
      <div id="user-container" v-show="currentApp === 'user'"></div>
      
      <!-- è®¢å•ç®¡ç†å­åº”ç”¨ -->
      <div id="order-container" v-show="currentApp === 'order'"></div>
      
      <!-- æ•°æ®åˆ†æå­åº”ç”¨ -->
      <div id="analytics-container" v-show="currentApp === 'analytics'"></div>
    </main>
  </div>
</template>

<script>
import { defineComponent, ref, computed } from 'vue'
import { useRoute } from 'vue-router'

export default defineComponent({
  name: 'MainLayout',
  setup() {
    const route = useRoute()
    const userInfo = ref({ name: 'Admin' })
    
    const currentApp = computed(() => {
      const path = route.path
      if (path.startsWith('/user')) return 'user'
      if (path.startsWith('/order')) return 'order'
      if (path.startsWith('/analytics')) return 'analytics'
      return null
    })
    
    const isActive = (path) => {
      return route.path.startsWith(path)
    }
    
    const logout = () => {
      localStorage.removeItem('token')
      window.location.href = '/login'
    }
    
    return {
      userInfo,
      currentApp,
      isActive,
      logout
    }
  }
})
</script>

<style scoped>
.main-layout {
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.main-nav {
  height: 60px;
  background: #001529;
  display: flex;
  align-items: center;
  padding: 0 20px;
  color: white;
}

.nav-brand {
  display: flex;
  align-items: center;
  margin-right: 40px;
}

.nav-brand img {
  width: 32px;
  height: 32px;
  margin-right: 12px;
}

.nav-menu {
  display: flex;
  list-style: none;
  margin: 0;
  padding: 0;
  flex: 1;
}

.nav-menu li {
  margin-right: 20px;
}

.nav-menu a {
  color: rgba(255, 255, 255, 0.65);
  text-decoration: none;
  padding: 0 16px;
  height: 60px;
  display: flex;
  align-items: center;
  transition: color 0.3s;
}

.nav-menu a:hover,
.nav-menu a.active {
  color: #1890ff;
}

.main-content {
  flex: 1;
  overflow: hidden;
}

#user-container,
#order-container,
#analytics-container {
  height: 100%;
  width: 100%;
}
</style>
```

### 2.3 å­åº”ç”¨å¼€å‘

#### Reactå­åº”ç”¨ï¼ˆç”¨æˆ·ç®¡ç†ï¼‰

```javascript
// user-app/src/index.js
import React from 'react'
import ReactDOM from 'react-dom'
import App from './App'
import { BrowserRouter } from 'react-router-dom'

// å…¨å±€å˜é‡ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦åœ¨qiankunç¯å¢ƒä¸­
const isQiankun = window.__POWERED_BY_QIANKUN__

function render(props = {}) {
  const { container, userInfo, token } = props
  
  // è®¾ç½®å…¨å±€çŠ¶æ€
  if (userInfo) {
    window.__USER_INFO__ = userInfo
  }
  if (token) {
    localStorage.setItem('token', token)
  }
  
  ReactDOM.render(
    <BrowserRouter basename={isQiankun ? '/user' : '/'}>
      <App />
    </BrowserRouter>,
    container ? container.querySelector('#root') : document.querySelector('#root')
  )
}

// ç‹¬ç«‹è¿è¡Œæ—¶ç›´æ¥æ¸²æŸ“
if (!isQiankun) {
  render()
}

// å¯¼å‡ºqiankunç”Ÿå‘½å‘¨æœŸ
export async function bootstrap() {
  console.log('[user-app] åº”ç”¨å¯åŠ¨')
}

export async function mount(props) {
  console.log('[user-app] åº”ç”¨æŒ‚è½½', props)
  render(props)
}

export async function unmount(props) {
  console.log('[user-app] åº”ç”¨å¸è½½', props)
  const { container } = props
  ReactDOM.unmountComponentAtNode(
    container ? container.querySelector('#root') : document.querySelector('#root')
  )
}
```

```jsx
// user-app/src/App.jsx
import React, { useState, useEffect } from 'react'
import { Routes, Route, Link } from 'react-router-dom'
import UserList from './components/UserList'
import UserDetail from './components/UserDetail'
import UserCreate from './components/UserCreate'
import './App.css'

function App() {
  const [users, setUsers] = useState([])
  const [loading, setLoading] = useState(false)
  
  useEffect(() => {
    fetchUsers()
  }, [])
  
  const fetchUsers = async () => {
    setLoading(true)
    try {
      const response = await fetch('/api/users', {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        }
      })
      const data = await response.json()
      setUsers(data)
    } catch (error) {
      console.error('è·å–ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error)
    } finally {
      setLoading(false)
    }
  }
  
  return (
    <div className="user-app">
      <div className="user-header">
        <h1>ç”¨æˆ·ç®¡ç†</h1>
        <nav className="user-nav">
          <Link to="/list">ç”¨æˆ·åˆ—è¡¨</Link>
          <Link to="/create">æ–°å¢ç”¨æˆ·</Link>
        </nav>
      </div>
      
      <div className="user-content">
        <Routes>
          <Route path="/list" element={
            <UserList 
              users={users} 
              loading={loading} 
              onRefresh={fetchUsers}
            />
          } />
          <Route path="/detail/:id" element={<UserDetail />} />
          <Route path="/create" element={
            <UserCreate onSuccess={fetchUsers} />
          } />
          <Route path="/" element={<UserList users={users} loading={loading} />} />
        </Routes>
      </div>
    </div>
  )
}

export default App
```

#### Vueå­åº”ç”¨ï¼ˆè®¢å•ç®¡ç†ï¼‰

```javascript
// order-app/src/main.js
import { createApp } from 'vue'
import { createRouter, createWebHistory } from 'vue-router'
import App from './App.vue'
import routes from './routes'

let app = null
let router = null

function render(props = {}) {
  const { container, apiBase } = props
  
  // åˆ›å»ºè·¯ç”±
  router = createRouter({
    history: createWebHistory(window.__POWERED_BY_QIANKUN__ ? '/order' : '/'),
    routes
  })
  
  // åˆ›å»ºåº”ç”¨
  app = createApp(App)
  app.use(router)
  
  // å…¨å±€é…ç½®
  if (apiBase) {
    app.config.globalProperties.$apiBase = apiBase
  }
  
  // æŒ‚è½½åº”ç”¨
  const containerElement = container ? container.querySelector('#app') : '#app'
  app.mount(containerElement)
}

// ç‹¬ç«‹è¿è¡Œ
if (!window.__POWERED_BY_QIANKUN__) {
  render()
}

// qiankunç”Ÿå‘½å‘¨æœŸ
export async function bootstrap() {
  console.log('[order-app] åº”ç”¨å¯åŠ¨')
}

export async function mount(props) {
  console.log('[order-app] åº”ç”¨æŒ‚è½½', props)
  render(props)
}

export async function unmount() {
  console.log('[order-app] åº”ç”¨å¸è½½')
  app?.unmount()
  app = null
  router = null
}
```

```vue
<!-- order-app/src/App.vue -->
<template>
  <div class="order-app">
    <div class="order-header">
      <h1>è®¢å•ç®¡ç†</h1>
      <div class="order-stats">
        <div class="stat-item">
          <span class="stat-label">ä»Šæ—¥è®¢å•</span>
          <span class="stat-value">{{ todayOrders }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">å¾…å¤„ç†</span>
          <span class="stat-value">{{ pendingOrders }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">æ€»é‡‘é¢</span>
          <span class="stat-value">Â¥{{ totalAmount }}</span>
        </div>
      </div>
    </div>
    
    <div class="order-content">
      <router-view />
    </div>
  </div>
</template>

<script>
import { defineComponent, ref, onMounted } from 'vue'
import { useOrderStore } from './stores/order'

export default defineComponent({
  name: 'OrderApp',
  setup() {
    const orderStore = useOrderStore()
    const todayOrders = ref(0)
    const pendingOrders = ref(0)
    const totalAmount = ref(0)
    
    onMounted(async () => {
      await loadOrderStats()
    })
    
    const loadOrderStats = async () => {
      try {
        const stats = await orderStore.getOrderStats()
        todayOrders.value = stats.todayOrders
        pendingOrders.value = stats.pendingOrders
        totalAmount.value = stats.totalAmount
      } catch (error) {
        console.error('åŠ è½½è®¢å•ç»Ÿè®¡å¤±è´¥:', error)
      }
    }
    
    return {
      todayOrders,
      pendingOrders,
      totalAmount
    }
  }
})
</script>

<style scoped>
.order-app {
  height: 100%;
  display: flex;
  flex-direction: column;
}

.order-header {
  padding: 20px;
  background: #f5f5f5;
  border-bottom: 1px solid #e8e8e8;
}

.order-header h1 {
  margin: 0 0 16px 0;
  color: #333;
}

.order-stats {
  display: flex;
  gap: 24px;
}

.stat-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 16px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  min-width: 120px;
}

.stat-label {
  font-size: 14px;
  color: #666;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 24px;
  font-weight: bold;
  color: #1890ff;
}

.order-content {
  flex: 1;
  padding: 20px;
  overflow: auto;
}
</style>
```

## ä¸‰ã€å¾®å‰ç«¯é€šä¿¡æœºåˆ¶

### 3.1 é€šä¿¡æ–¹æ¡ˆå¯¹æ¯”

```mermaid
graph TD
    A[å¾®å‰ç«¯é€šä¿¡æ–¹æ¡ˆ] --> B[Propsä¼ é€’]
    A --> C[å…¨å±€çŠ¶æ€]
    A --> D[äº‹ä»¶æ€»çº¿]
    A --> E[å…±äº«å­˜å‚¨]
    A --> F[URLå‚æ•°]
    
    B --> B1[ç®€å•æ•°æ®ä¼ é€’]
    C --> C1[Vuex/Reduxå…±äº«]
    D --> D1[EventBus/PubSub]
    E --> E1[LocalStorage/SessionStorage]
    F --> F1[è·¯ç”±å‚æ•°ä¼ é€’]
```

### 3.2 å®ç°å…¨å±€çŠ¶æ€ç®¡ç†

```javascript
// shared/src/store/global-store.js
class GlobalStore {
  constructor() {
    this.state = {
      user: null,
      token: null,
      theme: 'light',
      language: 'zh-CN'
    }
    
    this.listeners = new Map()
    this.middlewares = []
  }
  
  // è®¢é˜…çŠ¶æ€å˜åŒ–
  subscribe(key, callback) {
    if (!this.listeners.has(key)) {
      this.listeners.set(key, new Set())
    }
    this.listeners.get(key).add(callback)
    
    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      this.listeners.get(key)?.delete(callback)
    }
  }
  
  // æ›´æ–°çŠ¶æ€
  setState(key, value) {
    const oldValue = this.state[key]
    
    // æ‰§è¡Œä¸­é—´ä»¶
    for (const middleware of this.middlewares) {
      const result = middleware(key, value, oldValue)
      if (result === false) {
        return // ä¸­é—´ä»¶é˜»æ­¢æ›´æ–°
      }
    }
    
    this.state[key] = value
    
    // é€šçŸ¥è®¢é˜…è€…
    this.listeners.get(key)?.forEach(callback => {
      callback(value, oldValue)
    })
    
    // æŒä¹…åŒ–åˆ°localStorage
    this.persistState(key, value)
  }
  
  // è·å–çŠ¶æ€
  getState(key) {
    return this.state[key]
  }
  
  // æ·»åŠ ä¸­é—´ä»¶
  use(middleware) {
    this.middlewares.push(middleware)
  }
  
  // æŒä¹…åŒ–çŠ¶æ€
  persistState(key, value) {
    const persistKeys = ['user', 'token', 'theme', 'language']
    if (persistKeys.includes(key)) {
      localStorage.setItem(`global_${key}`, JSON.stringify(value))
    }
  }
  
  // ä»localStorageæ¢å¤çŠ¶æ€
  restoreState() {
    const persistKeys = ['user', 'token', 'theme', 'language']
    persistKeys.forEach(key => {
      const stored = localStorage.getItem(`global_${key}`)
      if (stored) {
        try {
          this.state[key] = JSON.parse(stored)
        } catch (error) {
          console.warn(`æ¢å¤çŠ¶æ€å¤±è´¥: ${key}`, error)
        }
      }
    })
  }
}

// åˆ›å»ºå…¨å±€å®ä¾‹
const globalStore = new GlobalStore()

// æ·»åŠ æ—¥å¿—ä¸­é—´ä»¶
globalStore.use((key, newValue, oldValue) => {
  console.log(`[GlobalStore] ${key}: ${JSON.stringify(oldValue)} -> ${JSON.stringify(newValue)}`)
  return true
})

// æ¢å¤æŒä¹…åŒ–çŠ¶æ€
globalStore.restoreState()

// å¯¼å‡ºå®ä¾‹å’Œå·¥å…·å‡½æ•°
export default globalStore

// React Hook
export function useGlobalState(key) {
  const [value, setValue] = React.useState(globalStore.getState(key))
  
  React.useEffect(() => {
    const unsubscribe = globalStore.subscribe(key, setValue)
    return unsubscribe
  }, [key])
  
  const updateValue = React.useCallback((newValue) => {
    globalStore.setState(key, newValue)
  }, [key])
  
  return [value, updateValue]
}

// Vue Composition API
export function useGlobalStateVue(key) {
  const value = ref(globalStore.getState(key))
  
  onMounted(() => {
    const unsubscribe = globalStore.subscribe(key, (newValue) => {
      value.value = newValue
    })
    
    onUnmounted(() => {
      unsubscribe()
    })
  })
  
  const updateValue = (newValue) => {
    globalStore.setState(key, newValue)
  }
  
  return [value, updateValue]
}
```

### 3.3 äº‹ä»¶æ€»çº¿å®ç°

```javascript
// shared/src/event-bus.js
class EventBus {
  constructor() {
    this.events = new Map()
    this.onceEvents = new Set()
    this.middlewares = []
  }
  
  // è®¢é˜…äº‹ä»¶
  on(eventName, callback, options = {}) {
    if (!this.events.has(eventName)) {
      this.events.set(eventName, new Set())
    }
    
    const listener = {
      callback,
      options,
      id: Symbol('listener')
    }
    
    this.events.get(eventName).add(listener)
    
    // è¿”å›å–æ¶ˆè®¢é˜…å‡½æ•°
    return () => {
      this.events.get(eventName)?.delete(listener)
    }
  }
  
  // ä¸€æ¬¡æ€§è®¢é˜…
  once(eventName, callback) {
    const unsubscribe = this.on(eventName, (...args) => {
      callback(...args)
      unsubscribe()
    })
    
    return unsubscribe
  }
  
  // å‘å¸ƒäº‹ä»¶
  emit(eventName, ...args) {
    // æ‰§è¡Œä¸­é—´ä»¶
    for (const middleware of this.middlewares) {
      const result = middleware(eventName, args)
      if (result === false) {
        return false // ä¸­é—´ä»¶é˜»æ­¢äº‹ä»¶å‘å¸ƒ
      }
    }
    
    const listeners = this.events.get(eventName)
    if (!listeners) return false
    
    let executed = 0
    
    listeners.forEach(listener => {
      try {
        // æ£€æŸ¥æ¡ä»¶
        if (listener.options.condition && !listener.options.condition(...args)) {
          return
        }
        
        // å¼‚æ­¥æ‰§è¡Œ
        if (listener.options.async) {
          setTimeout(() => listener.callback(...args), 0)
        } else {
          listener.callback(...args)
        }
        
        executed++
      } catch (error) {
        console.error(`äº‹ä»¶å¤„ç†å™¨æ‰§è¡Œå¤±è´¥ [${eventName}]:`, error)
      }
    })
    
    return executed > 0
  }
  
  // æ·»åŠ ä¸­é—´ä»¶
  use(middleware) {
    this.middlewares.push(middleware)
  }
  
  // ç§»é™¤æ‰€æœ‰ç›‘å¬å™¨
  off(eventName) {
    this.events.delete(eventName)
  }
  
  // è·å–äº‹ä»¶ç»Ÿè®¡
  getStats() {
    const stats = {
      totalEvents: this.events.size,
      totalListeners: 0,
      events: {}
    }
    
    this.events.forEach((listeners, eventName) => {
      stats.totalListeners += listeners.size
      stats.events[eventName] = listeners.size
    })
    
    return stats
  }
}

// åˆ›å»ºå…¨å±€äº‹ä»¶æ€»çº¿
const eventBus = new EventBus()

// æ·»åŠ æ—¥å¿—ä¸­é—´ä»¶
eventBus.use((eventName, args) => {
  console.log(`[EventBus] å‘å¸ƒäº‹ä»¶: ${eventName}`, args)
  return true
})

export default eventBus

// å¸¸ç”¨äº‹ä»¶å®šä¹‰
export const EVENTS = {
  USER_LOGIN: 'user:login',
  USER_LOGOUT: 'user:logout',
  THEME_CHANGE: 'theme:change',
  LANGUAGE_CHANGE: 'language:change',
  NOTIFICATION: 'notification:show',
  ROUTE_CHANGE: 'route:change'
}

// ä¾¿æ·æ–¹æ³•
export const userEvents = {
  login: (userInfo) => eventBus.emit(EVENTS.USER_LOGIN, userInfo),
  logout: () => eventBus.emit(EVENTS.USER_LOGOUT),
  onLogin: (callback) => eventBus.on(EVENTS.USER_LOGIN, callback),
  onLogout: (callback) => eventBus.on(EVENTS.USER_LOGOUT, callback)
}

export const themeEvents = {
  change: (theme) => eventBus.emit(EVENTS.THEME_CHANGE, theme),
  onChange: (callback) => eventBus.on(EVENTS.THEME_CHANGE, callback)
}
```

### 3.4 åœ¨å­åº”ç”¨ä¸­ä½¿ç”¨é€šä¿¡æœºåˆ¶

```jsx
// user-app/src/components/UserProfile.jsx
import React, { useEffect } from 'react'
import { useGlobalState } from '@shared/global-store'
import eventBus, { userEvents, EVENTS } from '@shared/event-bus'

function UserProfile() {
  const [user, setUser] = useGlobalState('user')
  const [theme, setTheme] = useGlobalState('theme')
  
  useEffect(() => {
    // ç›‘å¬ä¸»é¢˜å˜åŒ–
    const unsubscribeTheme = eventBus.on(EVENTS.THEME_CHANGE, (newTheme) => {
      console.log('ç”¨æˆ·åº”ç”¨æ”¶åˆ°ä¸»é¢˜å˜åŒ–:', newTheme)
      // åº”ç”¨ä¸»é¢˜åˆ°å½“å‰ç»„ä»¶
      document.body.className = `theme-${newTheme}`
    })
    
    return () => {
      unsubscribeTheme()
    }
  }, [])
  
  const handleLogout = () => {
    // æ¸…é™¤ç”¨æˆ·ä¿¡æ¯
    setUser(null)
    
    // å‘å¸ƒç™»å‡ºäº‹ä»¶
    userEvents.logout()
    
    // æ˜¾ç¤ºé€šçŸ¥
    eventBus.emit(EVENTS.NOTIFICATION, {
      type: 'success',
      message: 'å·²æˆåŠŸé€€å‡ºç™»å½•'
    })
  }
  
  const handleThemeToggle = () => {
    const newTheme = theme === 'light' ? 'dark' : 'light'
    setTheme(newTheme)
    
    // é€šçŸ¥å…¶ä»–åº”ç”¨ä¸»é¢˜å˜åŒ–
    eventBus.emit(EVENTS.THEME_CHANGE, newTheme)
  }
  
  if (!user) {
    return <div>è¯·å…ˆç™»å½•</div>
  }
  
  return (
    <div className={`user-profile theme-${theme}`}>
      <div className="profile-header">
        <img src={user.avatar} alt="å¤´åƒ" className="avatar" />
        <div className="user-info">
          <h3>{user.name}</h3>
          <p>{user.email}</p>
        </div>
      </div>
      
      <div className="profile-actions">
        <button onClick={handleThemeToggle}>
          åˆ‡æ¢åˆ°{theme === 'light' ? 'æ·±è‰²' : 'æµ…è‰²'}ä¸»é¢˜
        </button>
        <button onClick={handleLogout} className="logout-btn">
          é€€å‡ºç™»å½•
        </button>
      </div>
    </div>
  )
}

export default UserProfile
```

## å››ã€å¾®å‰ç«¯éƒ¨ç½²ä¸è¿ç»´

### 4.1 ç‹¬ç«‹éƒ¨ç½²ç­–ç•¥

```yaml
# docker-compose.yml
version: '3.8'

services:
  # ä¸»åº”ç”¨
  main-app:
    build: ./main-app
    ports:
      - "8080:80"
    environment:
      - NODE_ENV=production
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - user-app
      - order-app
      - analytics-app
  
  # ç”¨æˆ·ç®¡ç†å­åº”ç”¨
  user-app:
    build: ./user-app
    ports:
      - "8081:80"
    environment:
      - NODE_ENV=production
      - API_BASE=http://api.example.com
  
  # è®¢å•ç®¡ç†å­åº”ç”¨
  order-app:
    build: ./order-app
    ports:
      - "8082:80"
    environment:
      - NODE_ENV=production
      - API_BASE=http://api.example.com
  
  # æ•°æ®åˆ†æå­åº”ç”¨
  analytics-app:
    build: ./analytics-app
    ports:
      - "8083:80"
    environment:
      - NODE_ENV=production
      - API_BASE=http://api.example.com
  
  # Nginxåå‘ä»£ç†
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/conf.d:/etc/nginx/conf.d
    depends_on:
      - main-app
      - user-app
      - order-app
      - analytics-app
```

```nginx
# nginx/nginx.conf
events {
    worker_connections 1024;
}

http {
    upstream main-app {
        server main-app:80;
    }
    
    upstream user-app {
        server user-app:80;
    }
    
    upstream order-app {
        server order-app:80;
    }
    
    upstream analytics-app {
        server analytics-app:80;
    }
    
    server {
        listen 80;
        server_name localhost;
        
        # ä¸»åº”ç”¨
        location / {
            proxy_pass http://main-app;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # æ”¯æŒWebSocketï¼ˆç”¨äºHMRï¼‰
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
        
        # ç”¨æˆ·ç®¡ç†å­åº”ç”¨
        location /user-app/ {
            proxy_pass http://user-app/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            # å¤„ç†CORS
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        }
        
        # è®¢å•ç®¡ç†å­åº”ç”¨
        location /order-app/ {
            proxy_pass http://order-app/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        }
        
        # æ•°æ®åˆ†æå­åº”ç”¨
        location /analytics-app/ {
            proxy_pass http://analytics-app/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            
            add_header Access-Control-Allow-Origin *;
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
            add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
        }
    }
}
```

### 4.2 CI/CDæµæ°´çº¿

```yaml
# .github/workflows/deploy.yml
name: å¾®å‰ç«¯éƒ¨ç½²æµæ°´çº¿

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # æ£€æµ‹å˜æ›´çš„åº”ç”¨
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      main-app: ${{ steps.changes.outputs.main-app }}
      user-app: ${{ steps.changes.outputs.user-app }}
      order-app: ${{ steps.changes.outputs.order-app }}
      analytics-app: ${{ steps.changes.outputs.analytics-app }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            main-app:
              - 'main-app/**'
              - 'shared/**'
            user-app:
              - 'user-app/**'
              - 'shared/**'
            order-app:
              - 'order-app/**'
              - 'shared/**'
            analytics-app:
              - 'analytics-app/**'
              - 'shared/**'
  
  # æ„å»ºå’Œæµ‹è¯•ä¸»åº”ç”¨
  build-main-app:
    needs: detect-changes
    if: needs.detect-changes.outputs.main-app == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'main-app/package-lock.json'
      
      - name: Install dependencies
        run: |
          cd main-app
          npm ci
      
      - name: Run tests
        run: |
          cd main-app
          npm run test:ci
      
      - name: Build application
        run: |
          cd main-app
          npm run build
      
      - name: Build Docker image
        run: |
          cd main-app
          docker build -t main-app:${{ github.sha }} .
      
      - name: Push to registry
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker tag main-app:${{ github.sha }} ${{ secrets.DOCKER_REGISTRY }}/main-app:${{ github.sha }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/main-app:${{ github.sha }}
  
  # æ„å»ºç”¨æˆ·ç®¡ç†åº”ç”¨
  build-user-app:
    needs: detect-changes
    if: needs.detect-changes.outputs.user-app == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'user-app/package-lock.json'
      
      - name: Install dependencies
        run: |
          cd user-app
          npm ci
      
      - name: Run tests
        run: |
          cd user-app
          npm run test:ci
      
      - name: Build application
        run: |
          cd user-app
          npm run build
      
      - name: Build and push Docker image
        run: |
          cd user-app
          docker build -t user-app:${{ github.sha }} .
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin
          docker tag user-app:${{ github.sha }} ${{ secrets.DOCKER_REGISTRY }}/user-app:${{ github.sha }}
          docker push ${{ secrets.DOCKER_REGISTRY }}/user-app:${{ github.sha }}
  
  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy-production:
    needs: [detect-changes, build-main-app, build-user-app]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Deploy to Kubernetes
        run: |
          # æ›´æ–°Kuberneteséƒ¨ç½²
          kubectl set image deployment/main-app main-app=${{ secrets.DOCKER_REGISTRY }}/main-app:${{ github.sha }}
          kubectl set image deployment/user-app user-app=${{ secrets.DOCKER_REGISTRY }}/user-app:${{ github.sha }}
          
          # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          kubectl rollout status deployment/main-app
          kubectl rollout status deployment/user-app
      
      - name: Run smoke tests
        run: |
          # è¿è¡Œå†’çƒŸæµ‹è¯•
          npm run test:smoke
```

### 4.3 ç›‘æ§ä¸æ—¥å¿—

```javascript
// shared/src/monitoring.js
class MicroFrontendMonitor {
  constructor() {
    this.metrics = {
      loadTime: new Map(),
      errorCount: new Map(),
      userActions: new Map()
    }
    
    this.setupErrorHandling()
    this.setupPerformanceMonitoring()
  }
  
  // é”™è¯¯ç›‘æ§
  setupErrorHandling() {
    window.addEventListener('error', (event) => {
      this.reportError({
        type: 'javascript',
        message: event.message,
        filename: event.filename,
        lineno: event.lineno,
        colno: event.colno,
        stack: event.error?.stack,
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        url: window.location.href
      })
    })
    
    window.addEventListener('unhandledrejection', (event) => {
      this.reportError({
        type: 'promise',
        message: event.reason?.message || 'Unhandled Promise Rejection',
        stack: event.reason?.stack,
        timestamp: Date.now(),
        userAgent: navigator.userAgent,
        url: window.location.href
      })
    })
  }
  
  // æ€§èƒ½ç›‘æ§
  setupPerformanceMonitoring() {
    // ç›‘æ§å­åº”ç”¨åŠ è½½æ—¶é—´
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach((entry) => {
        if (entry.entryType === 'navigation') {
          this.reportMetric({
            type: 'navigation',
            name: 'page_load_time',
            value: entry.loadEventEnd - entry.loadEventStart,
            timestamp: Date.now()
          })
        }
        
        if (entry.entryType === 'resource') {
          // ç›‘æ§å­åº”ç”¨èµ„æºåŠ è½½
          if (entry.name.includes('/user-app/') || 
              entry.name.includes('/order-app/') || 
              entry.name.includes('/analytics-app/')) {
            
            this.reportMetric({
              type: 'resource',
              name: 'subapp_resource_load',
              value: entry.duration,
              resource: entry.name,
              timestamp: Date.now()
            })
          }
        }
      })
    })
    
    observer.observe({ entryTypes: ['navigation', 'resource'] })
  }
  
  // ä¸ŠæŠ¥é”™è¯¯
  reportError(error) {
    const appName = this.getCurrentAppName()
    
    // å¢åŠ é”™è¯¯è®¡æ•°
    const currentCount = this.metrics.errorCount.get(appName) || 0
    this.metrics.errorCount.set(appName, currentCount + 1)
    
    // å‘é€åˆ°ç›‘æ§æœåŠ¡
    this.sendToMonitoringService({
      type: 'error',
      app: appName,
      data: error
    })
    
    // æœ¬åœ°å­˜å‚¨ï¼ˆç”¨äºç¦»çº¿æ—¶é‡è¯•ï¼‰
    this.storeOfflineData('error', { app: appName, data: error })
  }
  
  // ä¸ŠæŠ¥æŒ‡æ ‡
  reportMetric(metric) {
    const appName = this.getCurrentAppName()
    
    this.sendToMonitoringService({
      type: 'metric',
      app: appName,
      data: metric
    })
  }
  
  // è·å–å½“å‰åº”ç”¨åç§°
  getCurrentAppName() {
    const path = window.location.pathname
    if (path.startsWith('/user')) return 'user-app'
    if (path.startsWith('/order')) return 'order-app'
    if (path.startsWith('/analytics')) return 'analytics-app'
    return 'main-app'
  }
  
  // å‘é€åˆ°ç›‘æ§æœåŠ¡
  async sendToMonitoringService(data) {
    try {
      await fetch('/api/monitoring', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          ...data,
          timestamp: Date.now(),
          sessionId: this.getSessionId(),
          userId: this.getUserId()
        })
      })
    } catch (error) {
      console.warn('ç›‘æ§æ•°æ®å‘é€å¤±è´¥:', error)
      this.storeOfflineData(data.type, data)
    }
  }
  
  // ç¦»çº¿æ•°æ®å­˜å‚¨
  storeOfflineData(type, data) {
    const key = `monitoring_${type}_${Date.now()}`
    localStorage.setItem(key, JSON.stringify(data))
    
    // æ¸…ç†è¿‡æœŸæ•°æ®
    this.cleanupOfflineData()
  }
  
  // æ¸…ç†è¿‡æœŸçš„ç¦»çº¿æ•°æ®
  cleanupOfflineData() {
    const maxAge = 7 * 24 * 60 * 60 * 1000 // 7å¤©
    const now = Date.now()
    
    Object.keys(localStorage).forEach(key => {
      if (key.startsWith('monitoring_')) {
        const timestamp = parseInt(key.split('_').pop())
        if (now - timestamp > maxAge) {
          localStorage.removeItem(key)
        }
      }
    })
  }
  
  // è·å–ä¼šè¯ID
  getSessionId() {
    let sessionId = sessionStorage.getItem('monitoring_session_id')
    if (!sessionId) {
      sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9)
      sessionStorage.setItem('monitoring_session_id', sessionId)
    }
    return sessionId
  }
  
  // è·å–ç”¨æˆ·ID
  getUserId() {
    return localStorage.getItem('user_id') || 'anonymous'
  }
  
  // è·å–ç›‘æ§ç»Ÿè®¡
  getStats() {
    return {
      errors: Object.fromEntries(this.metrics.errorCount),
      loadTimes: Object.fromEntries(this.metrics.loadTime),
      userActions: Object.fromEntries(this.metrics.userActions)
    }
  }
}

// åˆ›å»ºå…¨å±€ç›‘æ§å®ä¾‹
const monitor = new MicroFrontendMonitor()

export default monitor

// ä¾¿æ·æ–¹æ³•
export const trackUserAction = (action, data) => {
  monitor.reportMetric({
    type: 'user_action',
    name: action,
    data,
    timestamp: Date.now()
  })
}

export const trackPageView = (page) => {
  monitor.reportMetric({
    type: 'page_view',
    name: page,
    timestamp: Date.now()
  })
}
```

## äº”ã€å¾®å‰ç«¯æœ€ä½³å®è·µä¸é¿å‘æŒ‡å—

### 5.1 æŠ€æœ¯é€‰å‹åŸåˆ™

```javascript
// å¾®å‰ç«¯æŠ€æœ¯é€‰å‹å†³ç­–æ ‘
class TechStackDecision {
  static evaluate(requirements) {
    const factors = {
      teamSize: requirements.teamSize,
      projectComplexity: requirements.projectComplexity,
      performanceRequirements: requirements.performanceRequirements,
      existingTechStack: requirements.existingTechStack,
      timeToMarket: requirements.timeToMarket
    }
    
    // å†³ç­–çŸ©é˜µ
    const solutions = [
      {
        name: 'qiankun',
        score: this.calculateScore(factors, {
          teamSize: { small: 3, medium: 5, large: 5 },
          complexity: { low: 4, medium: 5, high: 4 },
          performance: { low: 4, medium: 4, high: 3 },
          learning: { easy: 5, medium: 4, hard: 3 }
        }),
        pros: ['å¼€ç®±å³ç”¨', 'ç”Ÿæ€å®Œå–„', 'ä¸­æ–‡æ–‡æ¡£'],
        cons: ['ä¸é˜¿é‡ŒæŠ€æœ¯æ ˆç»‘å®š', 'å®šåˆ¶åŒ–ç¨‹åº¦æœ‰é™']
      },
      {
        name: 'Module Federation',
        score: this.calculateScore(factors, {
          teamSize: { small: 2, medium: 4, large: 5 },
          complexity: { low: 3, medium: 4, high: 5 },
          performance: { low: 5, medium: 5, high: 5 },
          learning: { easy: 2, medium: 3, hard: 4 }
        }),
        pros: ['æ€§èƒ½æœ€ä¼˜', 'åŸç”Ÿæ”¯æŒ', 'çµæ´»æ€§é«˜'],
        cons: ['éœ€è¦Webpack 5', 'å­¦ä¹ æˆæœ¬é«˜']
      },
      {
        name: 'single-spa',
        score: this.calculateScore(factors, {
          teamSize: { small: 2, medium: 3, large: 4 },
          complexity: { low: 3, medium: 4, high: 5 },
          performance: { low: 4, medium: 4, high: 4 },
          learning: { easy: 2, medium: 3, hard: 4 }
        }),
        pros: ['çµæ´»æ€§æœ€é«˜', 'ç¤¾åŒºæ´»è·ƒ', 'æ¡†æ¶æ— å…³'],
        cons: ['é…ç½®å¤æ‚', 'éœ€è¦è¾ƒå¤šå®šåˆ¶å¼€å‘']
      }
    ]
    
    return solutions.sort((a, b) => b.score - a.score)
  }
  
  static calculateScore(factors, weights) {
    // ç®€åŒ–çš„è¯„åˆ†ç®—æ³•
    let score = 0
    
    // æ ¹æ®å›¢é˜Ÿè§„æ¨¡
    if (factors.teamSize <= 5) score += weights.teamSize.small
    else if (factors.teamSize <= 20) score += weights.teamSize.medium
    else score += weights.teamSize.large
    
    // æ ¹æ®é¡¹ç›®å¤æ‚åº¦
    if (factors.projectComplexity <= 3) score += weights.complexity.low
    else if (factors.projectComplexity <= 7) score += weights.complexity.medium
    else score += weights.complexity.high
    
    return score
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const recommendation = TechStackDecision.evaluate({
  teamSize: 15,
  projectComplexity: 8,
  performanceRequirements: 'high',
  existingTechStack: ['React', 'Vue'],
  timeToMarket: 'medium'
})

console.log('æ¨èæ–¹æ¡ˆ:', recommendation[0])
```

### 5.2 å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

#### é—®é¢˜1ï¼šæ ·å¼å†²çª

```css
/* é—®é¢˜ï¼šå…¨å±€æ ·å¼æ±¡æŸ“ */
.button {
  background: red; /* è¿™ä¼šå½±å“æ‰€æœ‰å­åº”ç”¨çš„button */
}

/* è§£å†³æ–¹æ¡ˆ1ï¼šCSS Modules */
.userApp_button_1a2b3c {
  background: red;
}

/* è§£å†³æ–¹æ¡ˆ2ï¼šCSS-in-JS */
.css-1a2b3c-button {
  background: red;
}

/* è§£å†³æ–¹æ¡ˆ3ï¼šå‘½åç©ºé—´ */
.user-app .button {
  background: red;
}

/* è§£å†³æ–¹æ¡ˆ4ï¼šShadow DOMï¼ˆqiankunä¸¥æ ¼æ ·å¼éš”ç¦»ï¼‰ */
/* è‡ªåŠ¨éš”ç¦»ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç† */
```

```javascript
// æ ·å¼éš”ç¦»é…ç½®
registerMicroApps([
  {
    name: 'user-app',
    entry: '//localhost:8081',
    container: '#user-container',
    activeRule: '/user'
  }
], {
  beforeLoad: [app => {
    console.log('åŠ è½½å‰', app.name)
  }],
  beforeMount: [app => {
    console.log('æŒ‚è½½å‰', app.name)
  }],
  afterMount: [app => {
    console.log('æŒ‚è½½å', app.name)
  }],
  beforeUnmount: [app => {
    console.log('å¸è½½å‰', app.name)
  }],
  afterUnmount: [app => {
    console.log('å¸è½½å', app.name)
  }]
})

start({
  sandbox: {
    strictStyleIsolation: true, // å¼€å¯ä¸¥æ ¼æ ·å¼éš”ç¦»
    experimentalStyleIsolation: true // å¼€å¯å®éªŒæ€§æ ·å¼éš”ç¦»
  }
})
```

#### é—®é¢˜2ï¼šè·¯ç”±å†²çª

```javascript
// é—®é¢˜ï¼šå­åº”ç”¨è·¯ç”±ä¸ä¸»åº”ç”¨å†²çª
// ä¸»åº”ç”¨è·¯ç”±
const mainRoutes = [
  { path: '/', component: Home },
  { path: '/about', component: About },
  { path: '/user/*', component: MicroAppContainer } // é€šé…ç¬¦è·¯ç”±
]

// å­åº”ç”¨è·¯ç”±
const userAppRoutes = [
  { path: '/', component: UserList }, // å†²çªï¼
  { path: '/detail/:id', component: UserDetail }
]

// è§£å†³æ–¹æ¡ˆï¼šè·¯ç”±å‰ç¼€
const userAppRoutes = [
  { path: '/user', component: UserList },
  { path: '/user/detail/:id', component: UserDetail }
]

// æˆ–è€…åœ¨å­åº”ç”¨ä¸­ä½¿ç”¨ç›¸å¯¹è·¯ç”±
const userAppRoutes = [
  { path: '', component: UserList }, // ç›¸å¯¹äº /user
  { path: 'detail/:id', component: UserDetail } // ç›¸å¯¹äº /user
]
```

#### é—®é¢˜3ï¼šä¾èµ–å†²çª

```javascript
// é—®é¢˜ï¼šä¸åŒç‰ˆæœ¬çš„ä¾èµ–å†²çª
// ä¸»åº”ç”¨ï¼šReact 17
// å­åº”ç”¨Aï¼šReact 18
// å­åº”ç”¨Bï¼šReact 16

// è§£å†³æ–¹æ¡ˆ1ï¼šexternalsé…ç½®
// webpack.config.js
module.exports = {
  externals: {
    'react': 'React',
    'react-dom': 'ReactDOM',
    'vue': 'Vue',
    'antd': 'antd'
  }
}

// è§£å†³æ–¹æ¡ˆ2ï¼šModule Federationå…±äº«ä¾èµ–
const ModuleFederationPlugin = require('@module-federation/webpack')

module.exports = {
  plugins: [
    new ModuleFederationPlugin({
      name: 'user_app',
      shared: {
        'react': {
          singleton: true, // ç¡®ä¿åªæœ‰ä¸€ä¸ªå®ä¾‹
          requiredVersion: '^17.0.0'
        },
        'react-dom': {
          singleton: true,
          requiredVersion: '^17.0.0'
        }
      }
    })
  ]
}
```

#### é—®é¢˜4ï¼šå†…å­˜æ³„æ¼

```javascript
// é—®é¢˜ï¼šå­åº”ç”¨å¸è½½æ—¶æœªæ¸…ç†èµ„æº
class ProblematicComponent {
  componentDidMount() {
    // å®šæ—¶å™¨æœªæ¸…ç†
    this.timer = setInterval(() => {
      this.fetchData()
    }, 1000)
    
    // äº‹ä»¶ç›‘å¬å™¨æœªç§»é™¤
    window.addEventListener('resize', this.handleResize)
    
    // å…¨å±€å˜é‡æœªæ¸…ç†
    window.globalData = this.data
  }
  
  componentWillUnmount() {
    // å¿˜è®°æ¸…ç†ï¼
  }
}

// è§£å†³æ–¹æ¡ˆï¼šå®Œå–„çš„æ¸…ç†æœºåˆ¶
class ProperComponent {
  componentDidMount() {
    this.timer = setInterval(() => {
      this.fetchData()
    }, 1000)
    
    this.handleResize = this.handleResize.bind(this)
    window.addEventListener('resize', this.handleResize)
    
    window.globalData = this.data
  }
  
  componentWillUnmount() {
    // æ¸…ç†å®šæ—¶å™¨
    if (this.timer) {
      clearInterval(this.timer)
      this.timer = null
    }
    
    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    window.removeEventListener('resize', this.handleResize)
    
    // æ¸…ç†å…¨å±€å˜é‡
    delete window.globalData
    
    // å–æ¶ˆæœªå®Œæˆçš„è¯·æ±‚
    if (this.abortController) {
      this.abortController.abort()
    }
  }
  
  fetchData() {
    this.abortController = new AbortController()
    
    fetch('/api/data', {
      signal: this.abortController.signal
    }).then(response => {
      // å¤„ç†å“åº”
    }).catch(error => {
      if (error.name !== 'AbortError') {
        console.error('è¯·æ±‚å¤±è´¥:', error)
      }
    })
  }
}
```

### 5.3 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

```javascript
// é¢„åŠ è½½ç­–ç•¥
class PreloadManager {
  constructor() {
    this.preloadedApps = new Map()
    this.preloadQueue = []
  }
  
  // æ™ºèƒ½é¢„åŠ è½½
  async intelligentPreload() {
    // æ ¹æ®ç”¨æˆ·è¡Œä¸ºé¢„æµ‹
    const userBehavior = this.analyzeUserBehavior()
    const predictions = this.predictNextApp(userBehavior)
    
    // æŒ‰ä¼˜å…ˆçº§é¢„åŠ è½½
    for (const { app, probability } of predictions) {
      if (probability > 0.7 && !this.preloadedApps.has(app)) {
        await this.preloadApp(app)
      }
    }
  }
  
  async preloadApp(appName) {
    try {
      console.log(`é¢„åŠ è½½åº”ç”¨: ${appName}`)
      
      // é¢„åŠ è½½èµ„æº
      const resources = await this.getAppResources(appName)
      await Promise.all(resources.map(url => this.preloadResource(url)))
      
      this.preloadedApps.set(appName, {
        timestamp: Date.now(),
        resources
      })
      
    } catch (error) {
      console.warn(`é¢„åŠ è½½å¤±è´¥: ${appName}`, error)
    }
  }
  
  preloadResource(url) {
    return new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'prefetch'
      link.href = url
      link.onload = resolve
      link.onerror = reject
      document.head.appendChild(link)
    })
  }
  
  analyzeUserBehavior() {
    // åˆ†æç”¨æˆ·è®¿é—®æ¨¡å¼
    const history = JSON.parse(localStorage.getItem('user_navigation_history') || '[]')
    const patterns = this.extractPatterns(history)
    return patterns
  }
  
  predictNextApp(behavior) {
    // ç®€åŒ–çš„é¢„æµ‹ç®—æ³•
    const predictions = [
      { app: 'user-app', probability: 0.8 },
      { app: 'order-app', probability: 0.6 },
      { app: 'analytics-app', probability: 0.3 }
    ]
    
    return predictions.sort((a, b) => b.probability - a.probability)
  }
}

// èµ„æºå…±äº«ä¼˜åŒ–
class ResourceOptimizer {
  constructor() {
    this.sharedResources = new Map()
    this.resourceCache = new Map()
  }
  
  // æå–å…¬å…±ä¾èµ–
  extractCommonDependencies(apps) {
    const dependencies = new Map()
    
    apps.forEach(app => {
      app.dependencies.forEach(dep => {
        if (!dependencies.has(dep.name)) {
          dependencies.set(dep.name, [])
        }
        dependencies.get(dep.name).push({
          app: app.name,
          version: dep.version
        })
      })
    })
    
    // æ‰¾å‡ºå…±åŒä¾èµ–
    const commonDeps = []
    dependencies.forEach((apps, depName) => {
      if (apps.length > 1) {
        const versions = apps.map(app => app.version)
        const commonVersion = this.findCompatibleVersion(versions)
        if (commonVersion) {
          commonDeps.push({
            name: depName,
            version: commonVersion,
            apps: apps.map(app => app.app)
          })
        }
      }
    })
    
    return commonDeps
  }
  
  findCompatibleVersion(versions) {
    // ç®€åŒ–çš„ç‰ˆæœ¬å…¼å®¹æ€§æ£€æŸ¥
    const majorVersions = versions.map(v => v.split('.')[0])
    const uniqueMajors = [...new Set(majorVersions)]
    
    if (uniqueMajors.length === 1) {
      // ä¸»ç‰ˆæœ¬ç›¸åŒï¼Œé€‰æ‹©æœ€é«˜çš„å°ç‰ˆæœ¬
      return versions.sort((a, b) => b.localeCompare(a, undefined, { numeric: true }))[0]
    }
    
    return null // ä¸å…¼å®¹
  }
  
  // ç”Ÿæˆä¼˜åŒ–åçš„æ„å»ºé…ç½®
  generateOptimizedConfig(commonDeps) {
    return {
      externals: commonDeps.reduce((acc, dep) => {
        acc[dep.name] = dep.name
        return acc
      }, {}),
      
      optimization: {
        splitChunks: {
          chunks: 'all',
          cacheGroups: {
            vendor: {
              test: /[\\/]node_modules[\\/]/,
              name: 'vendors',
              chunks: 'all'
            },
            common: {
              name: 'common',
              minChunks: 2,
              chunks: 'all',
              enforce: true
            }
          }
        }
      }
    }
  }
}
```

## å…­ã€æœªæ¥å±•æœ›ï¼šå¾®å‰ç«¯çš„å‘å±•è¶‹åŠ¿

### 6.1 æŠ€æœ¯å‘å±•æ–¹å‘

```mermaid
graph TD
    A[å¾®å‰ç«¯æœªæ¥å‘å±•] --> B[æŠ€æœ¯æ ‡å‡†åŒ–]
    A --> C[æ€§èƒ½ä¼˜åŒ–]
    A --> D[å¼€å‘ä½“éªŒ]
    A --> E[ç”Ÿæ€å®Œå–„]
    
    B --> B1[Web Componentsæ ‡å‡†]
    B --> B2[ES ModulesåŸç”Ÿæ”¯æŒ]
    B --> B3[Import Mapsæ ‡å‡†åŒ–]
    
    C --> C1[æ›´å¥½çš„ä»£ç åˆ†å‰²]
    C --> C2[æ™ºèƒ½é¢„åŠ è½½]
    C --> C3[è¾¹ç¼˜è®¡ç®—é›†æˆ]
    
    D --> D1[é›¶é…ç½®æ–¹æ¡ˆ]
    D --> D2[å¯è§†åŒ–è°ƒè¯•å·¥å…·]
    D --> D3[çƒ­æ›´æ–°ä¼˜åŒ–]
    
    E --> E1[æ¡†æ¶æ— å…³æ€§å¢å¼º]
    E --> E2[ç›‘æ§å·¥å…·å®Œå–„]
    E --> E3[æœ€ä½³å®è·µæ ‡å‡†åŒ–]
```

### 6.2 æ–°å…´æŠ€æœ¯é›†æˆ

```javascript
// Web Components + å¾®å‰ç«¯
class MicroAppElement extends HTMLElement {
  constructor() {
    super()
    this.attachShadow({ mode: 'open' })
  }
  
  async connectedCallback() {
    const appName = this.getAttribute('app-name')
    const appEntry = this.getAttribute('app-entry')
    
    try {
      // åŠ¨æ€åŠ è½½å¾®åº”ç”¨
      const app = await this.loadMicroApp(appName, appEntry)
      
      // åœ¨Shadow DOMä¸­æ¸²æŸ“
      await app.mount(this.shadowRoot)
      
    } catch (error) {
      this.renderError(error)
    }
  }
  
  async loadMicroApp(name, entry) {
    // ä½¿ç”¨ES ModulesåŠ¨æ€å¯¼å…¥
    const module = await import(entry)
    return module.default
  }
  
  disconnectedCallback() {
    // æ¸…ç†èµ„æº
    this.cleanup()
  }
}

// æ³¨å†Œè‡ªå®šä¹‰å…ƒç´ 
customElements.define('micro-app', MicroAppElement)

// ä½¿ç”¨æ–¹å¼
// <micro-app app-name="user-app" app-entry="/apps/user-app/index.js"></micro-app>
```

### 6.3 AIè¾…åŠ©çš„å¾®å‰ç«¯å¼€å‘

```javascript
// AIé©±åŠ¨çš„åº”ç”¨æ‹†åˆ†å»ºè®®
class AIArchitectAssistant {
  constructor() {
    this.analyzer = new CodeAnalyzer()
    this.recommender = new ArchitectureRecommender()
  }
  
  async analyzeMigration(codebase) {
    // åˆ†æç°æœ‰ä»£ç åº“
    const analysis = await this.analyzer.analyze(codebase)
    
    // è¯†åˆ«ä¸šåŠ¡è¾¹ç•Œ
    const boundaries = this.identifyBusinessBoundaries(analysis)
    
    // ç”Ÿæˆæ‹†åˆ†å»ºè®®
    const recommendations = this.recommender.generateSplitPlan(boundaries)
    
    return {
      currentArchitecture: analysis.architecture,
      businessBoundaries: boundaries,
      migrationPlan: recommendations,
      estimatedEffort: this.estimateEffort(recommendations)
    }
  }
  
  identifyBusinessBoundaries(analysis) {
    // åŸºäºä»£ç ç»“æ„ã€ä¾èµ–å…³ç³»ã€ä¸šåŠ¡é€»è¾‘è¯†åˆ«è¾¹ç•Œ
    const boundaries = []
    
    // åˆ†ææ¨¡å—é—´çš„è€¦åˆåº¦
    const coupling = this.calculateCoupling(analysis.modules)
    
    // è¯†åˆ«é«˜å†…èšã€ä½è€¦åˆçš„æ¨¡å—ç»„
    const clusters = this.clusterModules(coupling)
    
    clusters.forEach(cluster => {
      boundaries.push({
        name: cluster.suggestedName,
        modules: cluster.modules,
        dependencies: cluster.externalDependencies,
        complexity: cluster.complexity,
        migrationPriority: cluster.priority
      })
    })
    
    return boundaries
  }
  
  generateMigrationCode(boundary) {
    // AIç”Ÿæˆè¿ç§»ä»£ç 
    return {
      mainAppChanges: this.generateMainAppCode(boundary),
      subAppScaffold: this.generateSubAppScaffold(boundary),
      sharedUtilities: this.generateSharedCode(boundary)
    }
  }
}
```

## æ€»ç»“

å¾®å‰ç«¯ä½œä¸ºè§£å†³å¤§å‹å‰ç«¯é¡¹ç›®å¤æ‚æ€§çš„é‡è¦æ¶æ„æ¨¡å¼ï¼Œå·²ç»åœ¨ä¼—å¤šä¼ä¸šä¸­å¾—åˆ°äº†æˆåŠŸåº”ç”¨ã€‚é€šè¿‡æœ¬æ–‡çš„æ·±å…¥æ¢è®¨ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

### æ ¸å¿ƒä»·å€¼
- **æŠ€æœ¯ç‹¬ç«‹æ€§**ï¼šä¸åŒå›¢é˜Ÿå¯ä»¥é€‰æ‹©æœ€é€‚åˆçš„æŠ€æœ¯æ ˆ
- **éƒ¨ç½²ç‹¬ç«‹æ€§**ï¼šé™ä½å‘å¸ƒé£é™©ï¼Œæé«˜è¿­ä»£æ•ˆç‡
- **å›¢é˜Ÿç‹¬ç«‹æ€§**ï¼šå‡å°‘å›¢é˜Ÿé—´çš„åè°ƒæˆæœ¬
- **æ‰©å±•æ€§**ï¼šæ›´å®¹æ˜“åº”å¯¹ä¸šåŠ¡å¿«é€Ÿå¢é•¿

### å®æ–½è¦ç‚¹
1. **é€‰æ‹©åˆé€‚çš„æŠ€æœ¯æ–¹æ¡ˆ**ï¼šæ ¹æ®å›¢é˜Ÿè§„æ¨¡ã€é¡¹ç›®å¤æ‚åº¦é€‰æ‹©
2. **å»ºç«‹å®Œå–„çš„é€šä¿¡æœºåˆ¶**ï¼šç¡®ä¿åº”ç”¨é—´çš„åè°ƒå·¥ä½œ
3. **é‡è§†ç›‘æ§å’Œè¿ç»´**ï¼šä¿éšœç³»ç»Ÿçš„ç¨³å®šæ€§
4. **éµå¾ªæœ€ä½³å®è·µ**ï¼šé¿å…å¸¸è§çš„é™·é˜±å’Œé—®é¢˜

### æœªæ¥è¶‹åŠ¿
å¾®å‰ç«¯æŠ€æœ¯æ­£åœ¨å‘ç€æ›´åŠ æ ‡å‡†åŒ–ã€æ™ºèƒ½åŒ–çš„æ–¹å‘å‘å±•ã€‚Web Componentsã€ES Modulesç­‰åŸç”ŸæŠ€æœ¯çš„æˆç†Ÿï¼Œä»¥åŠAIè¾…åŠ©å¼€å‘å·¥å…·çš„å‡ºç°ï¼Œå°†è¿›ä¸€æ­¥é™ä½å¾®å‰ç«¯çš„å®æ–½é—¨æ§›ã€‚

è®°ä½ï¼Œå¾®å‰ç«¯ä¸æ˜¯é“¶å¼¹ï¼Œå®ƒè§£å†³äº†æŸäº›é—®é¢˜ï¼Œä½†ä¹Ÿå¸¦æ¥äº†æ–°çš„å¤æ‚æ€§ã€‚åœ¨å†³å®šæ˜¯å¦é‡‡ç”¨å¾®å‰ç«¯æ¶æ„æ—¶ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘å›¢é˜Ÿèƒ½åŠ›ã€é¡¹ç›®éœ€æ±‚å’Œé•¿æœŸç»´æŠ¤æˆæœ¬ã€‚

æœ€é‡è¦çš„æ˜¯ï¼ŒæŠ€æœ¯æœåŠ¡äºä¸šåŠ¡ï¼Œé€‰æ‹©æœ€é€‚åˆå½“å‰é˜¶æ®µçš„æ¶æ„æ–¹æ¡ˆï¼Œæ‰æ˜¯æ˜æ™ºçš„å†³ç­–ã€‚