## å“åº”å¼ç³»ç»Ÿï¼ˆå››ï¼‰

å…³äº Vue 2 å“åº”å¼ç³»ç»Ÿçš„å‰ä¸‰èŠ‚å·²ç»è®²è¿°äº† â€œæ•°æ®åŠ«æŒ Observerâ€ ä¸ â€œä¾èµ–æ”¶é›†åˆ†å‘ Depâ€ï¼Œä½†æ˜¯å…³äº â€œä¾èµ–æ”¶é›†åˆ†å‘â€ éƒ¨åˆ†è¿˜æœ‰è¿˜æœ‰ â€œè§‚å¯Ÿè€… Watcherâ€ æ²¡æœ‰è§£æã€‚

ä¸Šæ–‡ä¹Ÿæåˆ°äº†ï¼ŒDep ä¸èƒ½è„±ç¦» Watcher å•ç‹¬ä½¿ç”¨ã€‚

### 1. Watcher å®šä¹‰

è¯¥ç±»å®šä¹‰ä½äº **src/core/observer/watcher.ts**ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š

```typescript
export default class Watcher implements DepTarget {
  vm?: Component | null
  expression: string
  cb: Function
  id: number
  deep: boolean
  user: boolean
  lazy: boolean
  sync: boolean
  dirty: boolean
  active: boolean
  deps: Array<Dep>
  newDeps: Array<Dep>
  depIds: SimpleSet
  newDepIds: SimpleSet
  before?: Function
  onStop?: Function
  noRecurse?: boolean
  getter: Function
  value: any
  post: boolean

  constructor(
    vm: Component | null,
    expOrFn: string | (() => any),
    cb: Function,
    options?: WatcherOptions | null,
    isRenderWatcher?: boolean
  ) {
    recordEffectScope(this, activeEffectScope || (vm ? vm._scope : undefined))
    if ((this.vm = vm)) {
      if (isRenderWatcher) {
        vm._watcher = this
      }
    }
    if (options) {
      this.deep = !!options.deep
      this.user = !!options.user
      this.lazy = !!options.lazy
      this.sync = !!options.sync
      this.before = options.before
    } else {
      this.deep = this.user = this.lazy = this.sync = false
    }
    this.cb = cb
    this.id = ++uid
    this.active = true
    this.post = false
    this.dirty = this.lazy
    this.deps = []
    this.newDeps = []
    this.depIds = new Set()
    this.newDepIds = new Set()
    this.expression = ''
    if (isFunction(expOrFn)) {
      this.getter = expOrFn
    } else {
      this.getter = parsePath(expOrFn)
      !this.getter && (this.getter = noop)
    }
    this.value = this.lazy ? undefined : this.get()
  }
  get() {
    pushTarget(this)
    let value
    const vm = this.vm
    try {
      value = this.getter.call(vm, vm)
    } catch (e: any) {
    } finally {
      this.deep && traverse(value)
      popTarget()
      this.cleanupDeps()
    }
    return value
  }

  addDep(dep: Dep) {
    const id = dep.id
    if (!this.newDepIds.has(id)) {
      this.newDepIds.add(id)
      this.newDeps.push(dep)
      if (!this.depIds.has(id)) {
        dep.addSub(this)
      }
    }
  }

  cleanupDeps() {
    let i = this.deps.length
    while (i--) {
      const dep = this.deps[i]
      if (!this.newDepIds.has(dep.id)) {
        dep.removeSub(this)
      }
    }
    let tmp: any = this.depIds
    this.depIds = this.newDepIds
    this.newDepIds = tmp
    this.newDepIds.clear()
    tmp = this.deps
    this.deps = this.newDeps
    this.newDeps = tmp
    this.newDeps.length = 0
  }
  
  // ... å…¶ä»–å®ä¾‹æ–¹æ³•
}
```

### 2. å‚æ•°å’Œå±æ€§åˆ†æ

åœ¨ **class Watcher** ä¸­å®šä¹‰äº†æ¥è¿‘ 20 ä¸ªå±æ€§ï¼ˆæ’é™¤äº† dev ç¯å¢ƒçš„ debug æ”¯æŒï¼‰ï¼Œé™¤äº†æ ‡è¯†å”¯ä¸€æ€§çš„ id å±æ€§ã€å½“å‰ç»„ä»¶å®ä¾‹çš„ vm å±æ€§ã€è§‚å¯Ÿå˜æ›´æ—¶çš„å›è°ƒ cb ä¹‹å¤–ï¼Œå…¶ä»–çš„å±æ€§å¤§è‡´å¯ä»¥è¿›è¡Œä»¥ä¸‹åˆ†ç±»ï¼š

1. è§‚å¯Ÿå¯¹è±¡ç›¸å…³å±æ€§ï¼ŒåŒ…æ‹¬ **expressionï¼Œgetterï¼Œvalueï¼Œdeep**ï¼Œå…¶ä¸­ expression ä¸»è¦æ˜¯ç”¨æ¥è¿›è¡Œå¼€å‘æ¨¡å¼ä¸‹çš„é”™è¯¯æç¤ºï¼Œgetter ç”¨æ¥è·å–å½“å‰æ—¶åˆ»ä¸‹ expOrFn è·å–åˆ°çš„å€¼ï¼Œdeep åˆ™è¡¨ç¤ºæ·±åº¦ç›‘å¬å¤„ç†
2. è§‚å¯Ÿå¯¹è±¡æ”¹å˜æ—¶çš„å›è°ƒå‡½æ•°æ‰§è¡Œæ§åˆ¶ï¼ŒåŒ…æ‹¬ **deepï¼Œlazyï¼Œdirtyï¼Œsyncï¼Œpostï¼Œactiveï¼Œbeforeï¼Œuser**
   1. å…¶ä¸­ **user** ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†å›è°ƒå‡½æ•°æ‰§è¡Œæ—¶çš„é”™è¯¯ä¿¡æ¯å¤„ç†ï¼Œé»˜è®¤æ˜¯ falseï¼Œå³ä¸å¤„ç†é”™è¯¯ï¼›
   2. **before** åˆ™æ˜¯ä¸€ä¸ªå¯é€‰çš„å‡½æ•°ï¼Œä¼šåœ¨ cb å›è°ƒå‡½æ•°æ‰§è¡Œå‰æ‰§è¡Œï¼Œè¿™ä¸€ç‚¹å¯ä»¥åœ¨ **$mount** æ–¹æ³•çš„å®šä¹‰ä¸­æœ‰æ˜ç¡®ä½“ç°ï¼ˆä¼šåœ¨ before ä¸­è§¦å‘ç”Ÿå‘½å‘¨æœŸ beforeUpdate çš„å‡½æ•°è°ƒç”¨ï¼‰
   3. **active** ç”¨æ¥æ§åˆ¶æ˜¯å¦å¯ä»¥è§¦å‘ï¼Œå³æ˜¯å¦æ‰§è¡Œ cb å›è°ƒ
   4. **dirty** åˆ™æ˜¯æ§åˆ¶ **computed** è®¡ç®—å±æ€§çš„å»¶è¿Ÿæ›´æ–°ï¼Œé…åˆ **lazy** ä¸€èµ·å®ç°ï¼›**sync** ä¸ **post** ç”¨æ¥ç¡®å®š cb æ‰§è¡Œæ—¶åˆ»ï¼Œæ˜¯å¦æ˜¯ç«‹å³æ‰§è¡Œæˆ–è€…ç­‰å¾…è¯¥æ¬¡æ•°æ®ã€è¯•å›¾æ›´æ–°ç»“æŸä¹‹åå†æ‰§è¡Œ
3. ä¾èµ–å¤„ç†éƒ¨åˆ†å±æ€§ï¼ŒåŒ…æ‹¬ **depsï¼ŒnewDepsï¼ŒdepIdsï¼ŒnewDepIds** å’Œ **onStop**ï¼Œå…¶ä¸­ **onStop** ç”¨æ¥å¤„ç†è¯¥è§‚å¯Ÿè€…ä¾èµ–é¡¹è¢«æƒ…å†µæ—¶æ‰§è¡Œçš„æ“ä½œï¼Œå…¶ä»–å‡ ä¸ªå±æ€§åˆ™æ˜¯ç”¨æ¥æ”¶é›†å½“å‰çŠ¶æ€è§£æ/æ‰§è¡Œ expOrFn æ—¶çš„ä¾èµ–ï¼Œå¹¶ä¸”é’ˆå¯¹æ€§èƒ½åšäº†ä¸€äº›ä¼˜åŒ–å¤„ç†ï¼ˆä¸‹é¢ä¼šè®²ï¼‰

### 3. å®ä¾‹åŒ–ä¸æ›´æ–°è¿‡ç¨‹

#### 3.1 å±æ€§åˆå§‹åŒ–

åœ¨ **new Watcher()** æ—¶ï¼Œé¦–å…ˆæ‰§è¡Œ **recordEffectScope()**ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šå°†è¯¥ watcher å®ä¾‹æ³¨å†Œåˆ° **`vm._scope.effects`** æ•°ç»„ä¸­ã€‚

> è¿™é‡Œä¸ Vue 2.7 ä¹‹å‰çš„ç‰ˆæœ¬æœ‰ä¸€äº›åŒºåˆ«ã€‚åœ¨ Vue 2.6.14 åŠä¹‹å‰çš„ç‰ˆæœ¬ä¸­ï¼Œç»„ä»¶å†…çš„ watcher å®ä¾‹éƒ½æ˜¯ç»‘å®šåœ¨ `vm._watchers` å±æ€§ä¸­çš„ã€‚

ä¹‹ååˆ™æ˜¯æ ¹æ® **options** å‚æ•°è¿›è¡Œå±æ€§åˆå§‹åŒ–ï¼Œè¿™é‡Œæœ‰ä»¥ä¸‹å‡ ç‚¹æ³¨æ„äº‹é¡¹ï¼š

1. **depIds** ä¸ **newDepIds** é‡‡ç”¨çš„æ˜¯ ES6 çš„ Set ç»“æ„ï¼Œåœ¨åç»­ **addDep** æ·»åŠ ä¾èµ–æ—¶å¯ä»¥é€šè¿‡ **depIds.has()** æ¥å»é™¤é‡å¤ä¾èµ–
2. **getter** ä¼šè¢«å®šä¹‰æˆä¸€ä¸ªå‡½æ•°ï¼Œå°±ç®—æ˜¯ä¸€ä¸ª **xxx.xxx.xxx** ç»“æ„çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿä¼šé€šè¿‡ **parsePath** è§£ææˆä¸€ä¸ªå‡½æ•°
3. é **lazy** æƒ…å†µï¼ˆé computed æˆ–è€…ç‰¹æ®Šå£°æ˜ï¼‰ä¸‹ï¼Œä¼šæ‰§è¡Œ **watcher.get()** æ¥åˆå§‹åŒ–å½“å‰æ—¶åˆ»ç›‘å¬åˆ°çš„ expOrFn çš„å€¼

#### 3.2 watcher.get() æ”¶é›†ä¾èµ–

åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œé¦–å…ˆå°±æ˜¯é€šè¿‡ **pushTarget(this)** å°† **Dep.target** æŒ‡å‘å½“å‰çš„ watcher å®ä¾‹ï¼Œä¿è¯åœ¨ watcher.get çš„è¿‡ç¨‹ä¸­æ”¶é›†åˆ°çš„ä¾èµ–éƒ½æ˜¯å¯¹åº”åˆ°è¯¥ watcher å®ä¾‹çš„ã€‚

ä¹‹ååˆ™æ˜¯æ‰§è¡Œ **this.getter.call(vm, vm)**ï¼Œè·å–åˆ° watcher å®ä¾‹çš„ç›‘å¬å¯¹è±¡ expOrFn æ­¤æ—¶å¯¹åº”çš„å€¼ï¼›å¹¶ä¸”åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šè¿›è¡Œæ•°æ®è¯»å–ï¼Œè§¦å‘ **Object.defineProperty** ä¸­å®šä¹‰çš„ **getter**ï¼Œè°ƒç”¨ **dep.depend()** æ‰§è¡Œä¾èµ–æ”¶é›†ã€‚ä¸Šä¸€èŠ‚ä¹Ÿå·²ç»è®²è¿‡ï¼Œdep.depend() å…¶å®å°±æ˜¯è°ƒç”¨ Dep.targetï¼ˆä¹Ÿå°±æ˜¯æ­¤æ—¶çš„ watcher å®ä¾‹ï¼‰çš„ addDep(this) æ–¹æ³•ï¼Œå°†è‡ªå·±ï¼ˆè¯¥æ•°æ®å¯¹åº”çš„ dep å®ä¾‹ï¼‰æ’å…¥åˆ° watcher çš„ **newDepsï¼ŒnewDepIds** ä¸­ï¼Œå¹¶ä¸”åªæœ‰åœ¨ **åŸæœ‰çš„ watcher.deps** ä¸­ä¸å­˜åœ¨è¿™ä¸ª dep å®ä¾‹ï¼Œæ‰ä¼šåœ¨ dep.subs ä¸­æ’å…¥è¯¥ watcherï¼Œè¿™æ ·å¯ä»¥é¿å… watcher é‡å¤ã€‚

å¦‚æœé…ç½®äº†æ·±åº¦ç›‘å¬ï¼ˆdeep ä¸º trueï¼‰æ—¶ï¼Œè¿˜ä¼šé€šè¿‡ traverse(value) éå†è·å–ç»“æœè§¦å‘æ¯ä¸€çº§å­å±æ€§çš„ getter æ¥è¿›è¡Œä¾èµ–æ”¶é›†ã€‚

æœ€ååˆ™æ˜¯è°ƒç”¨ **popTarget()** ç»“æŸå½“å‰é˜¶æ®µçš„ä¾èµ–æ”¶é›†ï¼Œå¹¶è°ƒç”¨ **cleanupDeps()** å°† **newDepsï¼ŒnewDepIds** çš„å€¼å¤åˆ¶ç»™ **deps, depIds** å¹¶æ¸…ç©ºã€‚

![image-20220907111154027](./image-20220907111154027.png)

> å½“ç„¶ï¼Œæ¸²æŸ“ watcherï¼ˆisRenderWatcher ä¸º trueï¼‰æ­¤æ—¶å¯¹åº”çš„ expOrFn ä¸ºï¼š
>
> ```typescript
> updateComponent = () => {
>   vm._update(vm._render(), hydrating)
> }
> ```
>
> è¿™ä¸ªæ¨¡æ¿è§£æè¿‡ç¨‹ä¸­è§£æåˆ°çš„å˜é‡éƒ½ä¼šæ·»åŠ åˆ° renderWatcher.deps ä¸­

#### 3.3 cleanupDeps() æ¸…é™¤ä¾èµ–

æ•´ä¸ª **cleanupDeps()** å‡½æ•°çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå°±æ˜¯æ¸…é™¤æ— ç”¨ä¾èµ–ï¼Œç„¶åå°† **newDeps, newDepIds** çš„å€¼èµ‹å€¼ç»™åŸå§‹çš„ **deps, depIds**ï¼Œå¹¶æŠŠ **newDeps, newDepIds** æ¸…ç©ºï¼Œæ–¹ä¾¿ä¸‹æ¬¡æ‰§è¡Œ get() å’Œ addDep() çš„æ‰§è¡Œã€‚

ä¸Šé¢å®šä¹‰é‡Œæœ‰ä½“ç°ï¼Œåœ¨ **addDep(dep)** æ—¶ï¼Œä¼šé¦–å…ˆåˆ¤æ–­ **newDepIds** ä¸­ä¸å­˜åœ¨è¿™ä¸ªæ•°æ®çš„ä¾èµ–å¼•ç”¨ depï¼Œå¹¶å°†è¿™ä¸ª dep æ·»åŠ åˆ° **newDepIds** å’Œ **newDeps** ä¸­ï¼›ä¸”å½“ **depIds** ä¸­ä¹Ÿä¸å­˜åœ¨è¯¥ dep æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œ **dep.addSub()**ï¼Œå°† watcher è§‚å¯Ÿè€…æ·»åŠ åˆ° dep çš„é€šçŸ¥å¯¹è±¡ subs ä¸­ã€‚

è€Œ **cleanupDeps()** ä¸­æœ€å…ˆæ‰§è¡Œçš„ **dep.removeSub(this)**ï¼Œå°±æ˜¯ä¸ºäº†ä¼˜åŒ–æ‰ä¸éœ€è¦è¢«é€šçŸ¥æ”¹å˜çš„ä¸€ç³»åˆ—è§‚å¯Ÿè€…ã€‚

æœ€å¸¸è§çš„åœºæ™¯å°±æ˜¯ä½¿ç”¨ **v-ifï¼Œv-else-ifï¼Œv-else** çš„åœºæ™¯ï¼Œå½“èŠ‚ç‚¹å¯¹åº”çš„æ¡ä»¶ä¸º false çš„æ—¶å€™ï¼ŒèŠ‚ç‚¹å†…éƒ¨å®šä¹‰çš„ä¸€ç³»åˆ—æ•°æ®å˜åŒ–éƒ½æ˜¯å¯ä»¥å–æ¶ˆç›‘å¬çš„ï¼Œå› ä¸ºæ­¤æ—¶çš„èŠ‚ç‚¹éƒ½ä¸ä¼šè¢«æ¸²æŸ“ï¼Œä¹Ÿæ²¡æœ‰åœ¨ get() ä¸­æ”¶é›†ç›¸å…³ä¾èµ–ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨å°†åŸæœ‰çš„ä¾èµ–ä» dep.subs ä¸­æ¸…ç†æ‰ã€‚

#### 3.4 run() ä¸ update() çŠ¶æ€æ›´æ–°

åœ¨æ•°æ®æ›´æ–°çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ **Observer - Object.defineProperty** å®šä¹‰çš„ setter æ–¹æ³•æ¥å¤„ç†ï¼Œæ­¤æ—¶ä¼šè§¦å‘ **dep.notify()**

è€Œ **dep.notify()** çš„é€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼Œå°±æ˜¯éå† **dep.subs** æ•°ç»„ï¼Œä¾æ¬¡æ‰§è¡Œ **sub[i].update()**ï¼›ä¸Šé¢çš„è¿‡ç¨‹ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œçš„ **sub[i]** å…¶å®å°±æ˜¯ä¾èµ–è¿™ä¸ªæ•°æ®çš„æ¯ä¸€ä¸ª watcher å®ä¾‹ã€‚

**é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ update()**

```typescript
update() {
  if (this.lazy) {
    this.dirty = true
  } else if (this.sync) {
    this.run()
  } else {
    queueWatcher(this)
  }
}
```

è¿™é‡Œä¹Ÿæ¯”è¾ƒæ¸…æ™°ï¼Œå°±æ˜¯ä¸‰ä¸ªåˆ¤æ–­ï¼š

1. lazy ä¸º trueï¼Œè¡¨ç¤ºå»¶è¿Ÿæ‰§è¡Œï¼Œæ­¤æ—¶æŠŠè„å€¼æ ‡å¿—ï¼ˆä¹Ÿå°±æ˜¯ computed çš„æƒ°æ€§æ›´æ–°æœºåˆ¶ï¼‰è®¾ç½®ä¸º true
2. å¦‚æœ sync ä¸º trueï¼Œè¡¨ç¤ºç«‹å³åŒæ­¥æ‰§è¡Œå›è°ƒï¼Œåˆ™ç›´æ¥æ‰§è¡Œ run() æ–¹æ³•
3. å…¶ä»–æƒ…å†µåˆ™ä½¿ç”¨ queueWatcher å°†è¯¥æ¬¡å›è°ƒæ’å…¥åˆ°æ›´æ–°åçš„æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œå¾…å½“å‰çš„ç»„ä»¶å®ä¾‹æ›´æ–°ç»“æŸä¹‹åå†ä¾æ¬¡æ‰§è¡Œï¼ˆå½“ç„¶ï¼Œæœ€åä¹Ÿæ˜¯é€šè¿‡ watcher.run() æ‰§è¡Œå›è°ƒæ–¹æ³• cbï¼‰

**ç„¶åå°±æ˜¯æ ¸å¿ƒæ–¹æ³•ä¹‹ä¸€ run()**

```typescript
run() {
  if (this.active) {
    const value = this.get()
    if (value !== this.value || isObject(value) || this.deep) {
      const oldValue = this.value
      this.value = value
      this.cb.call(this.vm, value, oldValue)
    }
  }
}
```

> å½“ç„¶è¿™é‡Œæˆ‘çœç•¥äº†é”™è¯¯å¤„ç†é‚£éƒ¨åˆ†å†…å®¹ã€‚

è¿™ä¸ªæ–¹æ³•ä¹Ÿå°±å¤„ç†äº†ä¸¤ä¸ªåœ°æ–¹ï¼š

1. æ›´æ–°å½“å‰ watcher çš„ value
2. æ‰§è¡Œ cb å‡½æ•°

### 4. computed æ”¯æŒ

åœ¨ä¸Šé¢çš„è¿‡ç¨‹ä¸­ï¼Œæåˆ°äº† computed é…ç½®äº§ç”Ÿçš„ watcher å®ä¾‹ï¼ˆcomputedWatcherï¼‰ï¼Œé»˜è®¤ä¼šå°† lazy è®¾ç½®ä¸º trueï¼Œé‚£ä¹ˆæ­¤æ—¶åœ¨æ‰§è¡Œ **watcher.update()** æ—¶æ˜¯ä¼šç›´æ¥é€€å‡ºçš„ï¼Œæ€ä¹ˆå¤„ç†è¿™ä¸ª lazy å’Œ dirty å‘¢ï¼Ÿ

æ‰€ä»¥ Watcher åˆå®šä¹‰äº†å¦å¤–ä¸¤ä¸ªæ–¹æ³•ï¼š**evaluate()** å’Œ **depend()**ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```typescript
evaluate() {
  this.value = this.get()
  this.dirty = false
}
depend() {
  let i = this.deps.length
  while (i--) {
    this.deps[i].depend()
  }
}
```

**evaluateï¼š**

åœ¨è§¦å‘ computed.getterï¼ˆå³è¯»å– computed é…ç½®çš„è®¡ç®—å±æ€§æ—¶ï¼‰ï¼Œæ‰ä¼šé€šè¿‡è¯¥æ–¹æ³•è·å–åˆ° watcher å®ä¾‹å½“å‰çš„å€¼ï¼Œå¹¶ä½œä¸º getter è¿”å›å€¼

**dependï¼š**

å¤„ç† computed.getter æ–¹æ³•ä¸­é‡åˆ°çš„å˜é‡ï¼Œå¹¶ç”Ÿæˆä¸€ä¸ª computedWatcher æ’å…¥åˆ°æ‰€æœ‰å˜é‡å¯¹åº”çš„ dep å®ä¾‹çš„ subs æ•°ç»„ä¸­

> è¿™é‡Œçš„é€»è¾‘å¯èƒ½æœ‰ç‚¹ç»•ï¼Œç¬”è€…çš„ç†è§£å’Œæè¿°ä¹Ÿå¯èƒ½æœ‰è¯¯å·®ï¼Œå¸Œæœ›å¤§å®¶å¤šå¤šåŒ…æ¶µå’ŒæŒ‡å‡ºé”™è¯¯ğŸ˜˜

### 5. v3 è¯­æ³•æ”¯æŒ

å› ä¸ºåœ¨ Vue 2.7 ä¹‹åæ˜¯é€‚é…äº† Vue 3 çš„ setup è¯­æ³•ï¼ˆç»„åˆå¼ apiï¼‰çš„ï¼Œè€Œ Vue 3 ä¸­çš„ watchEffect æ”¯æŒå–æ¶ˆç›‘å¬ï¼Œæ‰€ä»¥ Watcher åˆå¢åŠ äº†ä¸€ä¸ªå–æ¶ˆä¾èµ–è®¢é˜…çš„æ–¹æ³•ã€‚

**teardownï¼š**

```typescript
teardown() {
  if (this.vm && !this.vm._isBeingDestroyed) {
    remove(this.vm._scope.effects, this)
  }
  if (this.active) {
    let i = this.deps.length
    while (i--) {
      this.deps[i].removeSub(this)
    }
    this.active = false
    if (this.onStop) {
      this.onStop()
    }
  }
}
```

ä½œç”¨å¦‚ä¸‹ï¼š

1. åœ¨å®ä¾‹è¿˜å­˜åœ¨ä¸”æ²¡æœ‰è¢«é”€æ¯æ—¶ï¼Œåœ¨ **vm._scope.effects** å°†è¯¥ watcher å®ä¾‹ç§»é™¤æ‰
2. å¦‚æœè¯¥ watcher å®ä¾‹æ˜¯æ´»åŠ¨çš„ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰é…ç½®å–æ¶ˆç›‘å¬ï¼‰ï¼Œä¼šä¾æ¬¡åœ¨ watcher.deps ä¸­æ¸…é™¤æ‰å½“å‰ watcher çš„ä¾èµ–ï¼Œå¹¶å°† active è®¾ç½®ä¸º false
3. å¦‚æœæœ‰é…ç½®åœæ­¢ç›‘å¬æ—¶çš„å¤„ç†æ–¹æ³•ï¼Œè¿˜ä¼šæ‰§è¡Œ onStop()

