## å“åº”å¼ç³»ç»Ÿï¼ˆä¸‰ï¼‰

ä¸Šä¸€èŠ‚ [å“åº”å¼ç³»ç»Ÿï¼ˆäºŒï¼‰](./Vue%202%20é˜…è¯»ç†è§£(16)%20-%20å“åº”å¼ç³»ç»Ÿï¼ˆäºŒï¼‰.md) ä¸­å¤§è‡´è¯´æ˜äº† **Observer** ä¸ **observe** é€šè¿‡ **Object.defineProperty** å®ç°æ•°æ®å“åº”å¼å¤„ç†çš„è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹ä¹Ÿå¸¸ç§°ä¸º **â€œæ•°æ®åŠ«æŒâ€**ã€‚é‚£ä¹ˆåœ¨æ•°æ®çš„æ›´æ–°ä¸è¯»å–è¿‡ç¨‹éƒ½è¢«åŠ«æŒä¹‹åï¼Œå°±è¯¥å¤„ç† dom ä¸æ•°æ®çš„ä¾èµ–å…³ç³»äº†ï¼Œæ‰€ä»¥è¿™ä¸€èŠ‚æˆ‘ä»¬ç®€å•å­¦ä¹ ä¸€ä¸‹ **Dep ä¾èµ–æ”¶é›†**ã€‚

### 1. Dep

Depï¼Œåº”è¯¥å°±æ˜¯ dependence çš„ç®€å†™ï¼Œè¡¨ç¤ºä¾èµ–å…³ç³»ï¼›å¹¶ä¸”è‚¯å®šå…·æœ‰ä¸¤ä¸ªå±æ€§ï¼šä¾èµ–è€…ï¼ˆè®¢é˜…è€…ï¼‰æ•°ç»„ä¸è¢«ä¾èµ–è€…ã€‚

Vue 2 ä¸­çš„ Dep æ„é€ å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š

```typescript
export interface DepTarget {
  id: number
  addDep(dep: Dep): void
  update(): void
}

export default class Dep {
  static target?: DepTarget | null
  id: number
  subs: Array<DepTarget>

  constructor() {
    this.id = uid++
    this.subs = []
  }

  addSub(sub: DepTarget) {
    this.subs.push(sub)
  }

  removeSub(sub: DepTarget) {
    remove(this.subs, sub)
  }

  depend() {
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify() {
    const subs = this.subs.slice()
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update()
    }
  }
}
```

> ä¸Šé¢çœç•¥äº†å¼€å‘ç¯å¢ƒä¸­çš„ debug å¤„ç†éƒ¨åˆ†ï¼›å¹¶ä¸”åœ¨å¼€å‘ç¯å¢ƒä¸‹è¿˜å¯ä»¥åœ¨ **notify** ä¸­é€‰æ‹©åŒæ­¥æŒ‰é¡ºåºæ‰§è¡Œã€‚

æ•´ä¸ª **Dep** ç±»çš„å®šä¹‰æ¯”è¾ƒç®€å•ï¼š

1. æ¥æ”¶ä¸€ä¸ªç±»é™æ€å±æ€§ **target**ï¼Œç”¨æ¥æ ‡è®°åé¢çš„è®¢é˜…è€…ä¾èµ–çš„æ•°æ®ã€‚å¹¶ä¸”è¿™é‡Œé‡‡ç”¨çš„æ˜¯é™æ€å±æ€§ï¼Œè€Œéæ¯ä¸ª Dep å®ä¾‹ç‹¬æœ‰çš„å±æ€§ï¼Œä¹Ÿæ˜¯ä¸ºäº†ä¿è¯å½“å‰ä¾èµ–è®¢é˜…è€…åœ¨å¤„ç†æ—¶ä¸ä¼šè¢«å…¶ä»–æ–¹å¼æ”¹å˜é€ æˆå¼‚å¸¸ï¼›å¹¶ä¸”è¯¥ target å¯¹è±¡å¿…é¡»åŒ…å«ä¸¤ä¸ªæ–¹æ³•ï¼š
   - addDepï¼šå°†å½“å‰ä¾èµ–æ·»åŠ åˆ°è®¢é˜…è€…çš„ä¾èµ–æ•°ç»„ä¸­
   - updateï¼šæ•°æ®æ”¹å˜æ—¶è§¦å‘çš„å›è°ƒå‡½æ•°
2. addSub ä¸ removeSubï¼šç”¨æ¥ç®¡ç†è¯¥ä¾èµ–çš„è®¢é˜…è€…æ•°ç»„
3. dependï¼šåœ¨å®šä¹‰äº† Dep.target ä¹‹åï¼Œå°†è¯¥ä¾èµ–æ·»åŠ åˆ°ä¾èµ–è®¢é˜…è€…çš„ä¾èµ–æ•°ç»„ä¸­
4. notifyï¼šåœ¨å½“å‰æ•°æ®æ”¹å˜æ—¶è§¦å‘æ‰€æœ‰ä¾èµ–è®¢é˜…è€…çš„æ›´æ–°æ“ä½œ

> å½“ç„¶ï¼Œæ­¤æ—¶è¿˜éœ€è¦ä¸€ä¸ªä¿®æ”¹ **Dep.target** çš„æ–¹æ³•

### 2. Dep.target

```typescript
Dep.target = null
const targetStack: Array<DepTarget | null | undefined> = []

export function pushTarget(target?: DepTarget | null) {
  targetStack.push(target)
  Dep.target = target
}

export function popTarget() {
  targetStack.pop()
  Dep.target = targetStack[targetStack.length - 1]
}
```

è¿™é‡Œé»˜è®¤ **Dep.target** æ˜¯ä¸€ä¸ªç©ºå€¼ï¼Œå¹¶ä¸”å®šä¹‰äº†ä¸€ä¸ªå˜é‡ **targetStack**ï¼Œæ ¹æ®å‘½åæ¥åˆ¤æ–­ï¼Œæ˜¯ç”¨æ¥ä¿å­˜å†å²çš„ **Dep.target** å¹¶å¯ä»¥å›é€€ä»¥å‰ç›®æ ‡å¯¹è±¡çš„æ ˆã€‚

> ğŸ“Œä¸ªäººç†è§£è¿™é‡Œä¸ºä»€ä¹ˆä¼šç”¨ä¸€ä¸ªæ•°ç»„å’Œä¸¤ä¸ªæ–¹æ³•æ¥å¤„ç†å½“å‰è®¢é˜…å¯¹è±¡ **Dep.target** ï¼Ÿ
>
> å› ä¸ºåœ¨å¤„ç†ç”Ÿå‘½å‘¨æœŸé’©å­å‡½æ•° callHookï¼Œåˆå§‹åŒ– data æ•°æ®ï¼Œè§¦å‘ watch å›è°ƒå‡½æ•°çš„æ—¶å€™ï¼Œä¸ºäº†é¿å…å†…éƒ¨æ•°æ®æ”¹å˜å¯¼è‡´ä¾èµ–å¯¹åº”çš„æ•°æ®çš„ä¾èµ–è®¢é˜…è€…ï¼ˆè§‚å¯Ÿè€…ï¼‰é‡å¤æ›´æ–°ï¼Œå¯¼è‡´æ•°æ®å’Œå›è°ƒå‡½æ•°é‡å¤æ›´æ–°ä¸æ‰§è¡Œï¼Œæ‰€ä»¥åœ¨ä»¥ä¸Šå‡ ä¸ªé˜¶æ®µéƒ½ä¼šåœæ­¢ä¾èµ–æ”¶é›†ã€‚è€Œé€šè¿‡ Stack å’Œä¸¤ä¸ªæ–¹æ³•ï¼Œå¯ä»¥ç®€å•é€šè¿‡å¤„ç†å¼€å§‹å‰è°ƒç”¨ pushTarget() æ¥åœæ­¢ä¾èµ–æ”¶é›†ï¼Œå¹¶åœ¨ç»“æŸåè°ƒç”¨ popTarget() æ¥æ¢å¤åŸæœ‰çš„ä¾èµ–å¼•ç”¨ã€‚

