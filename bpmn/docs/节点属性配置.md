# Bpmn.js 涉及节点类型与节点属性

> 解析文件基于 camunda，flowable与activiti替换对应前缀即可
>
> 所有节点属性均来自 `Element.businessObject` ，剩余属性未列出，可直接打印查看（使用 Vue 时大部分属性不能直接监听变化）

## 0.  扩展元素等说明

### 0.1 Bpmn

```typescript
// 内置基础类型
// https://github.com/lppedd/bpmnio-typings/blob/master/src/%40types/diagram-js/index.d.ts#L45-L48
export abstract class ModdleBase {
    get(name: string): any;
    set(name: string, value: any): void;
}
// https://github.com/lppedd/bpmnio-typings/blob/master/src/%40types/diagram-js/index.d.ts#L50-L65
export abstract class ModdleElement extends ModdleBase {
    static $model: Moddle;
    static $descriptor: Descriptor;

    readonly $type: string;
    $model: Moddle;
    $descriptor: Descriptor;
    $attrs: any;
    $parent: ModdleElement;
    $instanceOf: ((type: string) => boolean) & ((element: Base, type: string) => boolean);

    di?: ModdleElement;
    [field: string]: any;

    static hasType(element: ModdleElement, type?: string): boolean;
}
// https://github.com/lppedd/bpmnio-typings/blob/master/src/%40types/bpmn-js/index.d.ts#L252-L257
export abstract class BpmnBaseElement extends ModdleElement {
    id: string;
    documentation?: BpmnDocumentation;
    extensionDefinitions?: BpmnExtensionDefinition[];
    extensionElements?: BpmnExtensionElements;
}

// ExtensionElements
export class BpmnExtensionElements extends ModdleElement {
    readonly $type: 'bpmn:ExtensionElements';
    values?: ModdleElement[]; // ExecutionListener, Properties, FailedJobRetryTimeCycle, FormData ...
    valueRef?: Element;
    extensionAttributeDefinition?: BpmnExtensionAttributeDefinition;
}

// Documentation
export class BpmnDocumentation extends BpmnBaseElement {
    readonly $type: 'bpmn:Documentation';
    text: string;
    textFormat: string;
}

// Expression
export class BpmnExpression extends BpmnBaseElement {
    readonly $type: 'bpmn:FormalExpression';
    body: string;
    language?: string;
    resource?: string;
}

// Message
export class BpmnMessage extends ModdleElement {
    readonly $type: 'bpmn:Message';
    id: string;
    name: string;
}

// Single
export class BpmnSingle extends ModdleElement {
    readonly $type: 'bpmn:Signal';
    id: string;
    name: string;
}

// Operation
export class BpmnOperation extends ModdleElement {
    readonly $type: 'bpmn:Operation';
    name: string;
    inMessageRef?: BpmnMessage;
    outMessageRef?: BpmnMessage;
	errorRef?: BpmnError;
    implementationRef?: string;
}

// TimerEventDefinition
export class BpmnTimerEventDefinition extends ModdleElement {
    readonly $type: 'bpmn:TimerEventDefinition';
    timeDate?: BpmnExpression;
    timeCycle?: BpmnExpression;
    timeDuration?: BpmnExpression;
}

// MessageEventDefinition
export class BpmnMessageEventDefinition extends ModdleElement {
    readonly $type: 'bpmn:MessageEventDefinition';
    id: string;
    messageRef?: BpmnMessage;
    operationRef?: BpmnOperation;
}

// ConditionalEventDefinition
export class BpmnConditionalEventDefinition extends ModdleElement {
    readonly $type: 'bpmn:ConditionalEventDefinition';
    id: string;
    variableName: string;
    condition?: BpmnExpression;
}

// SignalEventDefinition
export class BpmnSignalEventDefinition extends ModdleElement {
    readonly $type: 'bpmn:SignalEventDefinition';
    id: string;
    singleRef: BpmnSingle;
}
```

### 0.2 Camunda/Activiti/Flowable

```typescript
// ExecutionListener
export class ExecutionListener extends ModdleElement {
    event: "start" | "end"; // 监听器事件类型
    class?: string; // 监听器类型 === class 时配置的 类地址
    expression?: string; // 监听器类型 === expression 时配置的 表达式
    delegateExpression?: string; // 监听器类型 === delegateExpression 时配置的 代理表达式
    script?: Script; // 监听器类型 === script 时配置的脚本内容
    fields?: Field[]; // 监听器注入的字段列表
}

// Script
export class Script extends ModdleElement {
    scriptFormat: string; // 脚本格式
    resource?: string; // 脚本类型为外部资源时配置的外部资源地址
    value?: string; // 脚本类型是内部脚本时配置的脚本正文
}

// Field
export class Field extends ModdleElement {
    name: string; // 字段名称
    string?: string; // 字段格式是字符串时配置的文本内容
    expression?: string; // 字段格式是表达式时配置的表达式正文
}

// Properties
export class Properties extends ModdleElement {
    values: Property[];
}

// Property
export class Property extends ModdleElement {
    name: string;
    value: string;
}

// FormData
export class FormData extends ModdleElement {
    businessKey: string;
    fields?: FormField[];
}

// FormField
export class FormField extends ModdleElement {
    id: string;
    label: string;
    type: string;
    datePattern?: string;
    defaultValue?: string;
    properties?: Properties;
    validation?: Validation;
    values?: Value;
}

// Validation
export class Validation extends ModdleElement {
    constraints?: Constraint[];
}

// Constraint
export class Constraint extends ModdleElement {
    name: string;
    config: stirng;
}
```

## 1. Process

外层流程定义部分，新建流程时可使用 `modeler.importXML(emptyXML)` 初始化一个基础流程， `emptyXML` 必须包含一个 `bpmn:Process` 元素。

`Process.businessObject` 属性如下：

```typescript
export class ProcessBusinessObject {
    id: string; // 流程id
    name?: string; // 流程名称
    versionTag?: string; // 版本标签
    isExecutable?: boolean; // 是否可执行
    taskPriority?: string; // 任务优先级
    jobPriority?: string; // 工作优先级
    candidateStarterGroups?: string; // 候选启动器配置 -- 候选启动器组(以英文逗号分隔的字符串)
    candidateStarterUsers?: string; // 候选启动器配置 -- 候选启动器用户(以英文逗号分隔的字符串)
    isStartableInTasklist?: boolean; // 任务列表配置 -- 是否可启动
    historyTimeToLive?: string; // 历史存活时间
    extensionElements?: BpmnExtensionElements; // 扩展元素
    documentation?: BpmnDocumentation[]; // 元素文档
    flowElements: ModdleElement[]; // 流程内部的所有元素实例
}
```

## 2. StartEvent

### 2.1 普通开始事件

```typescript
export class NormalStartEventBusinessObject {
    id: string;
    name?: string; // 名称（具有名称会创建一个 label 元素）
    initiator?: string; // 创建者
    async?: boolean;
    asyncBefore?: boolean;
    asyncAfter?: boolean;
    jobPriority?: string;
    formKey?: string;
    extensionElements?: BpmnExtensionElements; // 扩展元素, 表单配置会包含在内
}
```

> 设置异步且配置时间周期后，会在 `extensionElements` 中创建一个 `FailedJobRetryTimeCycle` 实例。
>
> 开始事件对应的表单配置（通常是流程引擎的解析文件支撑的，格式为 `FormData` ）也会包含在 `extensionElements` 中。

### 2.2 定时任务开始事件

```typescript
export class TimerStartEventBusinessObject extends NormalStartEventBusinessObject {
    eventDefinitions: BpmnTimerEventDefinition[];
}
```

### 2.3 消息开始事件

```typescript
export class MessageStartEventBusinessObject extends NormalStartEventBusinessObject {
    eventDefinitions: BpmnMessageEventDefinition[];
}
```

### 2.4 独立启动事件

```typescript
export class SingleStartEventBusinessObject extends NormalStartEventBusinessObject {
    eventDefinitions: BpmnSingleEventDefinition[];
}
```



























